<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin | Commandes & Livraisons -Smart cut services</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-admin: #4f46e5;
            --primary-admin-dark: #4338ca;
            --secondary-admin: #10b981;
            --danger-admin: #ef4444;
            --warning-admin: #f59e0b;
            --success-admin: #10b981;
            --bg-admin: #f8fafc;
            --sidebar-width: 280px;
        }
        
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            box-sizing: border-box;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        
        .status-confirmed {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        
        .status-delivered {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        
        /* Card hover effects */
        .hover-card {
            transition: all 0.2s ease;
        }
        
        .hover-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Loading spinner */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tab indicator */
        .tab-indicator {
            position: relative;
        }
        
        .tab-indicator::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary-admin);
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }
        
        .tab-indicator.active::after {
            transform: scaleX(1);
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            backdrop-filter: blur(4px);
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Toast animations */
        .toast-enter {
            animation: slideInRight 0.3s ease-out;
        }
        
        .toast-exit {
            animation: slideOutRight 0.3s ease-out forwards;
        }
        
        @keyframes slideOutRight {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Pulse animation for notifications */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Order details animation */
        .order-detail-enter {
            animation: slideInRight 0.4s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Admin Dashboard Container -->
    <div id="dashboard-container" class="min-h-screen flex flex-col">
        
        <!-- Admin Header -->
        <header class="bg-white shadow-md border-b border-gray-200 sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <!-- Logo and Title -->
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                        <div class="w-10 h-10 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-shipping-fast text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Centre de Contrôle</h1>
                            <p class="text-gray-600 text-sm">Commandes & Livraisons •Smart cut services</p>
                        </div>
                    </div>
                    
                    <!-- Admin Controls -->
                    <div class="flex items-center space-x-4">
                        <!-- Notifications -->
                        <div class="relative">
                            <button id="notifications-btn" class="p-2 text-gray-600 hover:text-indigo-600 transition-colors duration-200 relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="pending-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                            </button>
                        </div>
                        
                        <!-- Admin Navigation -->
                        <div class="hidden md:flex items-center space-x-2">
                            <button 
                                onclick="window.location.href = 'admin-dashboard.html'"
                                class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition-colors duration-200"
                            >
                                <i class="fas fa-boxes mr-2"></i>
                                Produits
                            </button>
                            <button 
                                onclick="window.location.href = '../index.html'"
                                class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors duration-200"
                            >
                                <i class="fas fa-store mr-2"></i>
                                Boutique
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- Dashboard Tabs -->
            <div class="mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex flex-wrap -mb-px space-x-2 md:space-x-8 overflow-x-auto">
                        <button 
                            id="tab-active-orders"
                            class="tab-indicator py-3 px-1 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 active:text-indigo-600 whitespace-nowrap"
                            onclick="switchTab('active-orders')"
                        >
                            <i class="fas fa-clock mr-2"></i>
                            Commandes Actives
                            <span id="active-orders-count" class="ml-2 px-2 py-0.5 bg-indigo-100 text-indigo-800 text-xs rounded-full">0</span>
                        </button>
                        
                        <button 
                            id="tab-order-verification"
                            class="tab-indicator py-3 px-1 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 whitespace-nowrap"
                            onclick="switchTab('order-verification')"
                        >
                            <i class="fas fa-qrcode mr-2"></i>
                            Vérification
                        </button>
                        
                        <button 
                            id="tab-order-history"
                            class="tab-indicator py-3 px-1 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 whitespace-nowrap"
                            onclick="switchTab('order-history')"
                        >
                            <i class="fas fa-history mr-2"></i>
                            Historique
                        </button>
                        
                        <button 
                            id="tab-delivery-rules"
                            class="tab-indicator py-3 px-1 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 whitespace-nowrap"
                            onclick="switchTab('delivery-rules')"
                        >
                            <i class="fas fa-truck mr-2"></i>
                            Règles Livraison
                        </button>
                        
                        <button 
                            id="tab-delivery-locations"
                            class="tab-indicator py-3 px-1 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 whitespace-nowrap"
                            onclick="switchTab('delivery-locations')"
                        >
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            Lieux de Livraison
                        </button>
                    </nav>
                </div>
            </div>
            
            <!-- Active Orders Tab Content -->
            <div id="tab-content-active-orders" class="tab-content">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl shadow p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">En attente</p>
                                <p id="pending-orders-count" class="text-2xl font-bold text-yellow-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Confirmées</p>
                                <p id="confirmed-orders-count" class="text-2xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Livrées</p>
                                <p id="delivered-orders-count" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-shipping-fast text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Total</p>
                                <p id="total-orders-count" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clipboard-list text-gray-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Orders Table -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                    <!-- Table Header -->
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <h3 class="font-semibold text-gray-800 text-lg">Commandes nécessitant une action</h3>
                            <div class="mt-2 md:mt-0 flex space-x-2">
                                <button 
                                    onclick="filterOrders('pending')"
                                    class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-medium transition-colors duration-200"
                                >
                                    En attente
                                </button>
                                <button 
                                    onclick="filterOrders('confirmed')"
                                    class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg text-sm font-medium transition-colors duration-200"
                                >
                                    Confirmées
                                </button>
                                <button 
                                    onclick="filterOrders('all')"
                                    class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition-colors duration-200"
                                >
                                    Toutes
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="orders-loading" class="p-8">
                        <div class="flex flex-col items-center justify-center">
                            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full loading-spinner mb-4"></div>
                            <p class="text-gray-600">Chargement des commandes...</p>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="orders-empty" class="hidden p-12 text-center">
                        <i class="fas fa-clipboard-check text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Aucune commande active</h3>
                        <p class="text-gray-500">Toutes les commandes sont traitées ou livrées.</p>
                    </div>
                    
                    <!-- Orders Table -->
                    <div id="orders-table-container" class="hidden overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50 text-gray-700 text-sm uppercase tracking-wider">
                                    <th class="px-6 py-4 text-left">Commande</th>
                                    <th class="px-6 py-4 text-left">Date</th>
                                    <th class="px-6 py-4 text-left">Client</th>
                                    <th class="px-6 py-4 text-left">Livraison</th>
                                    <th class="px-6 py-4 text-left">Montant</th>
                                    <th class="px-6 py-4 text-left">Statut</th>
                                    <th class="px-6 py-4 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody" class="divide-y divide-gray-200">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Order Verification Tab Content -->
            <div id="tab-content-order-verification" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <h3 class="font-semibold text-gray-800 text-lg mb-4">Vérification par code de commande</h3>
                    <p class="text-gray-600 mb-6">Entrez le code de commande pour vérifier son statut et effectuer des actions.</p>
                    
                    <!-- Verification Form -->
                    <div class="max-w-2xl">
                        <div class="flex flex-col md:flex-row md:items-end space-y-4 md:space-y-0 md:space-x-4">
                            <div class="flex-grow">
                                <label for="order-code-input" class="block text-sm font-medium text-gray-700 mb-2">
                                    Code de commande
                                </label>
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="order-code-input"
                                        placeholder="Ex: CMD123456789"
                                        class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    >
                                    <i class="fas fa-qrcode absolute left-4 top-3.5 text-gray-400"></i>
                                </div>
                            </div>
                            <button 
                                onclick="verifyOrderCode()"
                                class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center h-[46px]"
                            >
                                <i class="fas fa-search mr-2"></i>
                                Vérifier
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Verification Result -->
                <div id="verification-result" class="hidden">
                    <!-- Result will be loaded here -->
                </div>
            </div>
            
            <!-- Order History Tab Content -->
            <div id="tab-content-order-history" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <h3 class="font-semibold text-gray-800 text-lg mb-4">Historique complet des commandes</h3>
                    
                    <!-- Filters -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between space-y-4 md:space-y-0 mb-6">
                        <div class="flex flex-wrap gap-2">
                            <button 
                                onclick="filterHistory('all')"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium transition-colors duration-200"
                            >
                                Toutes
                            </button>
                            <button 
                                onclick="filterHistory('pending')"
                                class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition-colors duration-200"
                            >
                                En attente
                            </button>
                            <button 
                                onclick="filterHistory('confirmed')"
                                class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition-colors duration-200"
                            >
                                Confirmées
                            </button>
                            <button 
                                onclick="filterHistory('delivered')"
                                class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition-colors duration-200"
                            >
                                Livrées
                            </button>
                            <button 
                                onclick="filterHistory('cancelled')"
                                class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition-colors duration-200"
                            >
                                Annulées
                            </button>
                        </div>
                        
                        <!-- Date Filter -->
                        <div class="flex items-center space-x-4">
                            <div>
                                <input 
                                    type="date" 
                                    id="history-date-from"
                                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                            </div>
                            <span class="text-gray-500">à</span>
                            <div>
                                <input 
                                    type="date" 
                                    id="history-date-to"
                                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                            </div>
                            <button 
                                onclick="applyHistoryFilters()"
                                class="px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium transition-colors duration-200"
                            >
                                <i class="fas fa-filter mr-2"></i>
                                Filtrer
                            </button>
                        </div>
                    </div>
                    
                    <!-- History Table -->
                    <div id="history-loading" class="p-8">
                        <div class="flex flex-col items-center justify-center">
                            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full loading-spinner mb-4"></div>
                            <p class="text-gray-600">Chargement de l'historique...</p>
                        </div>
                    </div>
                    
                    <div id="history-table-container" class="hidden overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50 text-gray-700 text-sm uppercase tracking-wider">
                                    <th class="px-6 py-4 text-left">Commande</th>
                                    <th class="px-6 py-4 text-left">Date</th>
                                    <th class="px-6 py-4 text-left">Client</th>
                                    <th class="px-6 py-4 text-left">Articles</th>
                                    <th class="px-6 py-4 text-left">Montant</th>
                                    <th class="px-6 py-4 text-left">Statut</th>
                                    <th class="px-6 py-4 text-left">Détails</th>
                                </tr>
                            </thead>
                            <tbody id="history-tbody" class="divide-y divide-gray-200">
                                <!-- History will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Delivery Rules Tab Content -->
            <div id="tab-content-delivery-rules" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                        <div>
                            <h3 class="font-semibold text-gray-800 text-lg">Règles de livraison</h3>
                            <p class="text-gray-600">Configurez les règles de calcul des frais de livraison utilisées par le panier client.</p>
                        </div>
                        <button 
                            onclick="openDeliveryRuleModal()"
                            class="mt-4 md:mt-0 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center"
                        >
                            <i class="fas fa-plus-circle mr-2"></i>
                            Nouvelle règle
                        </button>
                    </div>
                    
                    <!-- Delivery Rules Table -->
                    <div id="delivery-rules-loading" class="p-8">
                        <div class="flex flex-col items-center justify-center">
                            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full loading-spinner mb-4"></div>
                            <p class="text-gray-600">Chargement des règles...</p>
                        </div>
                    </div>
                    
                    <div id="delivery-rules-container" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-50 text-gray-700 text-sm uppercase tracking-wider">
                                        <th class="px-6 py-4 text-left">Poids max (kg)</th>
                                        <th class="px-6 py-4 text-left">Frais de base</th>
                                        <th class="px-6 py-4 text-left">Frais fragile</th>
                                        <th class="px-6 py-4 text-left">Description</th>
                                        <th class="px-6 py-4 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="delivery-rules-tbody" class="divide-y divide-gray-200">
                                    <!-- Rules will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 text-lg mr-3 mt-0.5"></i>
                                <div>
                                    <h4 class="font-medium text-blue-800 mb-1">Comment fonctionnent les règles ?</h4>
                                    <p class="text-blue-700 text-sm">
                                        Le système utilise la première règle dont le "Poids max" est supérieur ou égal au poids total de la commande. 
                                        Les règles sont appliquées dans l'ordre croissant de poids maximum.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Delivery Locations Tab Content -->
            <div id="tab-content-delivery-locations" class="tab-content hidden">
                <div class="mb-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Meeting Points Section -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="font-semibold text-gray-800 text-lg">Points de rencontre</h3>
                                    <p class="text-gray-600">Lieux de rencontre pour livraison</p>
                                </div>
                                <button 
                                    onclick="openMeetingPointModal()"
                                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center"
                                >
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Ajouter
                                </button>
                            </div>
                            
                            <div id="meeting-points-loading" class="p-8">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full loading-spinner mb-4"></div>
                                    <p class="text-gray-600">Chargement...</p>
                                </div>
                            </div>
                            
                            <div id="meeting-points-container" class="hidden space-y-4">
                                <!-- Meeting points will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Store Locations Section -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="font-semibold text-gray-800 text-lg">Magasins</h3>
                                    <p class="text-gray-600">Points de retrait en magasin</p>
                                </div>
                                <button 
                                    onclick="openStoreLocationModal()"
                                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center"
                                >
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Ajouter
                                </button>
                            </div>
                            
                            <div id="store-locations-loading" class="p-8">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full loading-spinner mb-4"></div>
                                    <p class="text-gray-600">Chargement...</p>
                                </div>
                            </div>
                            
                            <div id="store-locations-container" class="hidden space-y-4">
                                <!-- Store locations will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 py-6">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-shipping-fast text-white"></i>
                            </div>
                            <span class="font-bold text-gray-800">Centre de Contrôle</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-1">Commandes & Livraisons •Smart cut services</p>
                    </div>
                    
                    <div class="text-center md:text-right">
                        <p class="text-gray-500 text-sm">&copy; <span id="current-year">2026</span>Smart cut services. Administration réservée.</p>
                        <p class="text-gray-500 text-sm">Dernière synchronisation: <span id="last-sync">--:--</span></p>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Order Detail Modal -->
    <div id="order-detail-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="modal-backdrop fixed inset-0" onclick="closeOrderDetailModal()"></div>
            
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden relative z-10 order-detail-enter">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Delivery Rule Modal -->
    <div id="delivery-rule-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="modal-backdrop fixed inset-0" onclick="closeDeliveryRuleModal()"></div>
            
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative z-10">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Meeting Point Modal -->
    <div id="meeting-point-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="modal-backdrop fixed inset-0" onclick="closeMeetingPointModal()"></div>
            
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative z-10">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Store Location Modal -->
    <div id="store-location-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="modal-backdrop fixed inset-0" onclick="closeStoreLocationModal()"></div>
            
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative z-10">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="modal-backdrop fixed inset-0" onclick="closeConfirmationModal()"></div>
            
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative z-10">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col space-y-2 max-w-md"></div>
        <!-- ------------------------------------------------------------------------------------------------------------
     ==========================================================================================================
     ==========================================
      --><!-- Bulle de navigation unique -->
<!-- Bulle de navigation unique -->
<div id="navBubbleUniq" class="fixed bottom-4 right-4 z-50 transition-all duration-300">
  <!-- Bouton principal de la bulle -->
  <button id="navBubbleBtnUniq" 
          class="w-14 h-14 md:w-16 md:h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 flex items-center justify-center group active:scale-95 focus:outline-none focus:ring-4 focus:ring-indigo-500/30">
    <i class="fas fa-rocket text-white text-xl md:text-2xl group-hover:rotate-90 transition-transform duration-300"></i>
    <span class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">7</span>
  </button>

  <!-- Menu déroulant -->
  <div id="navBubbleMenuUniq" 
       class="absolute bottom-20 right-0 w-72 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl opacity-0 scale-95 pointer-events-none transition-all duration-300 transform origin-bottom-right border border-gray-100 dark:border-gray-700">
    
    <!-- En-tête du menu -->
    <div class="p-4 border-b border-gray-100 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
          <i class="fas fa-space-shuttle text-indigo-500"></i>
          Navigation Dashboard
        </h3>
        <span class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-300 rounded-full">7 liens</span>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Accès rapide aux sections principales</p>
    </div>

    <!-- Liste des liens -->
    <div class="p-2 space-y-1 max-h-96 overflow-y-auto custom-scrollbar-uniq">
      <!-- Lien Dashboard Accueil -->
      <a href="dashacceuil.html" 
         class="navBubbleLinkUniq flex items-center gap-3 p-3 rounded-xl hover:bg-indigo-50 dark:hover:bg-gray-700 transition-colors duration-200 group focus:outline-none focus:bg-indigo-50 dark:focus:bg-gray-700">
        <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-home text-indigo-600 dark:text-indigo-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-800 dark:text-white truncate">Dashboard Accueil</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Tableau de bord principal</p>
        </div>
        <i class="fas fa-chevron-right text-gray-400 group-hover:text-indigo-500 transition-colors flex-shrink-0"></i>
      </a>

      <!-- Lien Confidentialité -->
      <a href="dashconfi.html" 
         class="navBubbleLinkUniq flex items-center gap-3 p-3 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors duration-200 group focus:outline-none focus:bg-blue-50 dark:focus:bg-gray-700">
        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-shield-alt text-blue-600 dark:text-blue-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-800 dark:text-white truncate">Confidentialité</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Gestion des données privées</p>
        </div>
        <i class="fas fa-chevron-right text-gray-400 group-hover:text-blue-500 transition-colors flex-shrink-0"></i>
      </a>

      <!-- Lien Livraison -->
      <a href="livraisondash.html" 
         class="navBubbleLinkUniq flex items-center gap-3 p-3 rounded-xl hover:bg-green-50 dark:hover:bg-gray-700 transition-colors duration-200 group focus:outline-none focus:bg-green-50 dark:focus:bg-gray-700">
        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-shipping-fast text-green-600 dark:text-green-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-800 dark:text-white truncate">Dashboard Livraison</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Suivi des commandes</p>
        </div>
        <i class="fas fa-chevron-right text-gray-400 group-hover:text-green-500 transition-colors flex-shrink-0"></i>
      </a>

      <!-- Lien Catalogue -->
      <a href="catalogue-admin.html" 
         class="navBubbleLinkUniq flex items-center gap-3 p-3 rounded-xl hover:bg-purple-50 dark:hover:bg-gray-700 transition-colors duration-200 group focus:outline-none focus:bg-purple-50 dark:focus:bg-gray-700">
        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-boxes text-purple-600 dark:text-purple-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-800 dark:text-white truncate">Catalogue Admin</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Gestion des produits</p>
        </div>
        <i class="fas fa-chevron-right text-gray-400 group-hover:text-purple-500 transition-colors flex-shrink-0"></i>
      </a>

      <!-- Lien Commandes -->
      <a href="panier.html" 
         class="navBubbleLinkUniq flex items-center gap-3 p-3 rounded-xl hover:bg-amber-50 dark:hover:bg-gray-700 transition-colors duration-200 group focus:outline-none focus:bg-amber-50 dark:focus:bg-gray-700">
        <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-shopping-cart text-amber-600 dark:text-amber-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-800 dark:text-white truncate">Commandes & Panier</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Paiements et transactions</p>
        </div>
        <i class="fas fa-chevron-right text-gray-400 group-hover:text-amber-500 transition-colors flex-shrink-0"></i>
      </a>

      <!-- Lien About -->
      <a href="dashabout.html" 
         class="navBubbleLinkUniq flex items-center gap-3 p-3 rounded-xl hover:bg-cyan-50 dark:hover:bg-gray-700 transition-colors duration-200 group focus:outline-none focus:bg-cyan-50 dark:focus:bg-gray-700">
        <div class="w-10 h-10 bg-cyan-100 dark:bg-cyan-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-info-circle text-cyan-600 dark:text-cyan-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-800 dark:text-white truncate">À propos</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Informations sur l'application</p>
        </div>
        <i class="fas fa-chevron-right text-gray-400 group-hover:text-cyan-500 transition-colors flex-shrink-0"></i>
      </a>

      <!-- Lien Transfert -->
      <a href="marquee.html" 
         class="navBubbleLinkUniq flex items-center gap-3 p-3 rounded-xl hover:bg-pink-50 dark:hover:bg-gray-700 transition-colors duration-200 group focus:outline-none focus:bg-pink-50 dark:focus:bg-gray-700">
        <div class="w-10 h-10 bg-pink-100 dark:bg-pink-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-exchange-alt text-pink-600 dark:text-pink-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-800 dark:text-white truncate">Transfert</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Transferts et transactions</p>
        </div>
        <i class="fas fa-chevron-right text-gray-400 group-hover:text-pink-500 transition-colors flex-shrink-0"></i>
      </a>
    </div>

    <!-- Footer du menu -->
    <div class="p-3 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 rounded-b-2xl">
      <div class="flex items-center justify-between">
        <div class="text-xs text-gray-500 dark:text-gray-400">
          <span class="font-medium">v1.2.0</span>
          <span class="mx-1">•</span>
          <span>Navigation avancée</span>
        </div>
        <button id="navBubbleCloseUniq" 
                class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
          <i class="fas fa-times text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Variables globales uniques pour la bulle
let navBubbleDragStateUniq = {
  isDragging: false,
  startX: 0,
  startY: 0,
  startLeft: 0,
  startTop: 0
};

let navBubbleMenuStateUniq = {
  isOpen: false,
  isAnimating: false
};

let navBubbleTouchTimerUniq = null;

// Références aux éléments DOM
const navBubbleContainerUniq = document.getElementById('navBubbleUniq');
const navBubbleToggleUniq = document.getElementById('navBubbleBtnUniq');
const navBubbleDropdownUniq = document.getElementById('navBubbleMenuUniq');
const navBubbleCloseTriggerUniq = document.getElementById('navBubbleCloseUniq');
const navBubbleMenuLinksUniq = document.querySelectorAll('.navBubbleLinkUniq');

// Initialisation de la bulle
function setupNavBubbleUniq() {
  loadNavBubblePositionUniq();
  attachNavBubbleEventsUniq();
  setupNavBubbleAccessibilityUniq();
  animateNavBubbleIntroUniq();
}

// Charger la position sauvegardée
function loadNavBubblePositionUniq() {
  const savedPos = localStorage.getItem('navBubblePositionV2');
  if (savedPos) {
    try {
      const { x, y } = JSON.parse(savedPos);
      const safeX = Math.max(10, Math.min(x, window.innerWidth - 70));
      const safeY = Math.max(10, Math.min(y, window.innerHeight - 70));
      
      navBubbleContainerUniq.style.left = `${safeX}px`;
      navBubbleContainerUniq.style.top = `${safeY}px`;
      navBubbleContainerUniq.style.right = 'auto';
      navBubbleContainerUniq.style.bottom = 'auto';
    } catch (e) {
      console.warn('Position de bulle invalide, utilisation par défaut');
    }
  }
}

// Sauvegarder la position
function saveNavBubblePositionUniq() {
  const rect = navBubbleContainerUniq.getBoundingClientRect();
  localStorage.setItem('navBubblePositionV2', JSON.stringify({
    x: rect.left,
    y: rect.top
  }));
}

// Attacher les événements
function attachNavBubbleEventsUniq() {
  // Événements desktop
  navBubbleToggleUniq.addEventListener('mousedown', startNavBubbleDragDesktopUniq);
  navBubbleToggleUniq.addEventListener('click', handleNavBubbleToggleClickUniq);
  navBubbleCloseTriggerUniq.addEventListener('click', closeNavBubbleMenuUniq);
  
  // Événements mobile touch
  navBubbleToggleUniq.addEventListener('touchstart', startNavBubbleTouchUniq, { passive: false });
  navBubbleToggleUniq.addEventListener('touchmove', handleNavBubbleTouchMoveUniq, { passive: false });
  navBubbleToggleUniq.addEventListener('touchend', endNavBubbleTouchUniq);
  
  // Événements globaux
  document.addEventListener('mousemove', handleNavBubbleDragDesktopUniq);
  document.addEventListener('mouseup', stopNavBubbleDragDesktopUniq);
  document.addEventListener('click', handleDocumentClickNavBubbleUniq);
  document.addEventListener('keydown', handleNavBubbleKeyboardUniq);
  window.addEventListener('resize', handleNavBubbleResizeUniq);
  
  // Prévenir le drag des images dans les liens
  navBubbleMenuLinksUniq.forEach(link => {
    link.addEventListener('dragstart', (e) => e.preventDefault());
  });
}

// Gestion du clic sur le bouton toggle
function handleNavBubbleToggleClickUniq(e) {
  if (navBubbleDragStateUniq.isDragging) {
    navBubbleDragStateUniq.isDragging = false;
    saveNavBubblePositionUniq();
    return;
  }
  
  e.stopPropagation();
  toggleNavBubbleMenuUniq();
}

// Ouvrir/fermer le menu
function toggleNavBubbleMenuUniq() {
  if (navBubbleMenuStateUniq.isAnimating) return;
  
  navBubbleMenuStateUniq.isAnimating = true;
  
  if (navBubbleMenuStateUniq.isOpen) {
    closeNavBubbleMenuUniq();
  } else {
    openNavBubbleMenuUniq();
  }
  
  setTimeout(() => {
    navBubbleMenuStateUniq.isAnimating = false;
  }, 300);
}

// Ouvrir le menu
function openNavBubbleMenuUniq() {
  navBubbleMenuStateUniq.isOpen = true;
  navBubbleDropdownUniq.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
  navBubbleDropdownUniq.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
  navBubbleToggleUniq.classList.add('from-purple-600', 'to-pink-600', 'ring-4', 'ring-purple-500/30');
  
  // Feedback haptique sur mobile
  if ('vibrate' in navigator) {
    navigator.vibrate(30);
  }
}

// Fermer le menu
function closeNavBubbleMenuUniq() {
  navBubbleMenuStateUniq.isOpen = false;
  navBubbleDropdownUniq.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
  navBubbleDropdownUniq.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
  navBubbleToggleUniq.classList.remove('from-purple-600', 'to-pink-600', 'ring-4', 'ring-purple-500/30');
}

// Drag desktop
function startNavBubbleDragDesktopUniq(e) {
  if (e.button !== 0) return; // Seulement clic gauche
  
  navBubbleDragStateUniq.isDragging = true;
  const rect = navBubbleContainerUniq.getBoundingClientRect();
  
  navBubbleDragStateUniq.startX = e.clientX;
  navBubbleDragStateUniq.startY = e.clientY;
  navBubbleDragStateUniq.startLeft = rect.left;
  navBubbleDragStateUniq.startTop = rect.top;
  
  navBubbleContainerUniq.style.transition = 'none';
  navBubbleContainerUniq.style.cursor = 'grabbing';
  closeNavBubbleMenuUniq();
}

function handleNavBubbleDragDesktopUniq(e) {
  if (!navBubbleDragStateUniq.isDragging) return;
  
  const deltaX = e.clientX - navBubbleDragStateUniq.startX;
  const deltaY = e.clientY - navBubbleDragStateUniq.startY;
  
  let newLeft = navBubbleDragStateUniq.startLeft + deltaX;
  let newTop = navBubbleDragStateUniq.startTop + deltaY;
  
  // Garder dans les limites
  const maxX = window.innerWidth - navBubbleContainerUniq.offsetWidth - 10;
  const maxY = window.innerHeight - navBubbleContainerUniq.offsetHeight - 10;
  
  newLeft = Math.max(10, Math.min(newLeft, maxX));
  newTop = Math.max(10, Math.min(newTop, maxY));
  
  navBubbleContainerUniq.style.left = `${newLeft}px`;
  navBubbleContainerUniq.style.top = `${newTop}px`;
  navBubbleContainerUniq.style.right = 'auto';
  navBubbleContainerUniq.style.bottom = 'auto';
}

function stopNavBubbleDragDesktopUniq() {
  if (!navBubbleDragStateUniq.isDragging) return;
  
  navBubbleDragStateUniq.isDragging = false;
  navBubbleContainerUniq.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  navBubbleContainerUniq.style.cursor = '';
  saveNavBubblePositionUniq();
}

// Touch mobile
function startNavBubbleTouchUniq(e) {
  if (e.touches.length !== 1) return;
  
  const touch = e.touches[0];
  
  navBubbleTouchTimerUniq = setTimeout(() => {
    // Long press pour drag
    navBubbleDragStateUniq.isDragging = true;
    const rect = navBubbleContainerUniq.getBoundingClientRect();
    
    navBubbleDragStateUniq.startX = touch.clientX;
    navBubbleDragStateUniq.startY = touch.clientY;
    navBubbleDragStateUniq.startLeft = rect.left;
    navBubbleDragStateUniq.startTop = rect.top;
    
    navBubbleContainerUniq.style.transition = 'none';
    closeNavBubbleMenuUniq();
    
    if ('vibrate' in navigator) {
      navigator.vibrate(50);
    }
  }, 500); // 500ms pour long press
}

function handleNavBubbleTouchMoveUniq(e) {
  if (!navBubbleDragStateUniq.isDragging || e.touches.length !== 1) return;
  
  e.preventDefault();
  const touch = e.touches[0];
  
  const deltaX = touch.clientX - navBubbleDragStateUniq.startX;
  const deltaY = touch.clientY - navBubbleDragStateUniq.startY;
  
  let newLeft = navBubbleDragStateUniq.startLeft + deltaX;
  let newTop = navBubbleDragStateUniq.startTop + deltaY;
  
  const maxX = window.innerWidth - navBubbleContainerUniq.offsetWidth - 10;
  const maxY = window.innerHeight - navBubbleContainerUniq.offsetHeight - 10;
  
  newLeft = Math.max(10, Math.min(newLeft, maxX));
  newTop = Math.max(10, Math.min(newTop, maxY));
  
  navBubbleContainerUniq.style.left = `${newLeft}px`;
  navBubbleContainerUniq.style.top = `${newTop}px`;
}

function endNavBubbleTouchUniq() {
  clearTimeout(navBubbleTouchTimerUniq);
  
  if (navBubbleDragStateUniq.isDragging) {
    navBubbleDragStateUniq.isDragging = false;
    navBubbleContainerUniq.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    saveNavBubblePositionUniq();
  }
}

// Gestion des clics en dehors
function handleDocumentClickNavBubbleUniq(e) {
  if (!navBubbleMenuStateUniq.isOpen) return;
  
  const isClickInside = navBubbleContainerUniq.contains(e.target);
  
  if (!isClickInside) {
    closeNavBubbleMenuUniq();
  }
}

// Gestion du clavier
function handleNavBubbleKeyboardUniq(e) {
  if (e.key === 'Escape' && navBubbleMenuStateUniq.isOpen) {
    closeNavBubbleMenuUniq();
  }
  
  // Navigation au clavier dans le menu
  if (e.key === 'Tab' && navBubbleMenuStateUniq.isOpen) {
    e.preventDefault();
    const currentIndex = Array.from(navBubbleMenuLinksUniq).indexOf(document.activeElement);
    let nextIndex;
    
    if (e.shiftKey) {
      nextIndex = currentIndex > 0 ? currentIndex - 1 : navBubbleMenuLinksUniq.length - 1;
    } else {
      nextIndex = currentIndex < navBubbleMenuLinksUniq.length - 1 ? currentIndex + 1 : 0;
    }
    
    if (navBubbleMenuLinksUniq[nextIndex]) {
      navBubbleMenuLinksUniq[nextIndex].focus();
    }
  }
}

// Redimensionnement
function handleNavBubbleResizeUniq() {
  const rect = navBubbleContainerUniq.getBoundingClientRect();
  const maxX = window.innerWidth - navBubbleContainerUniq.offsetWidth - 10;
  const maxY = window.innerHeight - navBubbleContainerUniq.offsetHeight - 10;
  
  if (rect.left > maxX || rect.top > maxY) {
    // Réinitialiser si hors écran
    navBubbleContainerUniq.style.left = 'auto';
    navBubbleContainerUniq.style.top = 'auto';
    navBubbleContainerUniq.style.right = '1rem';
    navBubbleContainerUniq.style.bottom = '1rem';
    localStorage.removeItem('navBubblePositionV2');
  }
}

// Accessibilité
function setupNavBubbleAccessibilityUniq() {
  navBubbleToggleUniq.setAttribute('aria-label', 'Ouvrir le menu de navigation');
  navBubbleToggleUniq.setAttribute('aria-expanded', 'false');
  navBubbleToggleUniq.setAttribute('role', 'button');
  
  navBubbleDropdownUniq.setAttribute('aria-hidden', 'true');
  navBubbleDropdownUniq.setAttribute('role', 'menu');
  
  navBubbleMenuLinksUniq.forEach((link, index) => {
    link.setAttribute('role', 'menuitem');
    link.setAttribute('tabindex', '-1');
  });
  
  // Mettre à jour les attributs ARIA quand le menu s'ouvre/ferme
  const observerNavBubbleUniq = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        const isOpen = navBubbleDropdownUniq.classList.contains('opacity-100');
        navBubbleToggleUniq.setAttribute('aria-expanded', isOpen.toString());
        navBubbleDropdownUniq.setAttribute('aria-hidden', (!isOpen).toString());
        
        navBubbleMenuLinksUniq.forEach(link => {
          link.setAttribute('tabindex', isOpen ? '0' : '-1');
        });
      }
    });
  });
  
  observerNavBubbleUniq.observe(navBubbleDropdownUniq, {
    attributes: true,
    attributeFilter: ['class']
  });
}

// Animation d'introduction
function animateNavBubbleIntroUniq() {
  navBubbleContainerUniq.classList.add('animate-bounce');
  setTimeout(() => {
    navBubbleContainerUniq.classList.remove('animate-bounce');
  }, 1500);
}

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    setupNavBubbleUniq();
  }, 100);
});
</script>

<style>
/* Styles additionnels pour la bulle de navigation */
.custom-scrollbar-uniq::-webkit-scrollbar {
  width: 6px;
}

.custom-scrollbar-uniq::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.custom-scrollbar-uniq::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.custom-scrollbar-uniq::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

.dark .custom-scrollbar-uniq::-webkit-scrollbar-track {
  background: #374151;
}

.dark .custom-scrollbar-uniq::-webkit-scrollbar-thumb {
  background: #4b5563;
}

.dark .custom-scrollbar-uniq::-webkit-scrollbar-thumb:hover {
  background: #6b7280;
}

/* Animation de pulse améliorée */
@keyframes navBubblePulseUniq {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 15px 35px rgba(99, 102, 241, 0.5);
  }
}

.animate-pulse {
  animation: navBubblePulseUniq 2s ease-in-out infinite;
}

/* Animation de rebond pour l'introduction */
@keyframes navBubbleBounceUniq {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-20px);
  }
}

.animate-bounce {
  animation: navBubbleBounceUniq 0.5s ease-in-out 3;
}

/* Support du dark mode avancé */
@media (prefers-color-scheme: dark) {
  #navBubbleBtnUniq {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
  }
  
  #navBubbleBtnUniq:hover {
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
  }
}

/* Responsive amélioré */
@media (max-width: 640px) {
  #navBubbleMenuUniq {
    width: calc(100vw - 2rem);
    max-width: 320px;
    right: 50%;
    transform: translateX(50%) scale(0.95);
    transform-origin: bottom center;
  }
  
  #navBubbleMenuUniq.opacity-100 {
    transform: translateX(50%) scale(1);
  }
  
  #navBubbleUniq {
    bottom: 1rem;
    right: 1rem;
  }
}

/* Transition fluide pour le menu */
#navBubbleMenuUniq {
  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
              transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Focus styles pour accessibilité */
.navBubbleLinkUniq:focus-visible {
  outline: 2px solid #4f46e5;
  outline-offset: -2px;
}

#navBubbleBtnUniq:focus-visible {
  outline: 2px solid #4f46e5;
  outline-offset: 2px;
}
</style>
<!-- =================================================================================================================================================
 ====================================================================================================================================
 ============================================================================================
  -->

    <!-- =====================================================================
     ===================================================================== -->
<div id="overlay-container"></div>
<script>
  fetch('overlay.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('overlay-container').innerHTML = html;
      initSecurityOverlay();
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>


<script src="overlay.js"></script>
<!-- ===================================================
 ==============
 ====================================================== -->

    <!-- JavaScript Application -->
<script>
    // ============================================
    // CONFIGURATION ET INITIALISATION
    // ============================================
    
    const firebaseConfig = {
  apiKey: "AIzaSyCOifibU2E6Vo-3Ohg-WmAHa43sa5HyFuw",
  authDomain: "smartcutservices.firebaseapp.com",
  projectId: "smartcutservices",
  storageBucket: "smartcutservices.firebasestorage.app",
  messagingSenderId: "589013273323",
  appId: "1:589013273323:web:415772e7b94f6bb37d8cae",
  measurementId: "G-R8GJXQP7BD"}


    // Mode débogage
    const DEBUG_MODE = true;
    function debugLog(message, data = null) {
        if (DEBUG_MODE) {
            console.log(`[DEBUG] ${message}`, data || '');
        }
    }
    
    // État global de l'application
    const adminState = {
        currentTab: 'active-orders',
        orders: [],
        filteredOrders: [],
        allOrders: [],
        deliveryRules: [],
        meetingPoints: [],
        storeLocations: [],
        currentOrderFilter: 'all',
        currentHistoryFilter: 'all',
        isLoading: false,
        orderListeners: {},
        stats: {
            pending: 0,
            confirmed: 0,
            delivered: 0,
            cancelled: 0,
            total: 0
        }
    };
    
    // ============================================
    // FONCTIONS UTILITAIRES GLOBALES
    // ============================================
    
    /**
     * Afficher une notification toast
     */
    window.showToast = function(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        const toastId = 'toast-' + Date.now();
        const typeConfig = {
            success: { bg: 'bg-green-500', icon: 'fa-check-circle' },
            error: { bg: 'bg-red-500', icon: 'fa-exclamation-circle' },
            warning: { bg: 'bg-yellow-500', icon: 'fa-exclamation-triangle' },
            info: { bg: 'bg-blue-500', icon: 'fa-info-circle' }
        }[type] || { bg: 'bg-blue-500', icon: 'fa-info-circle' };
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `${typeConfig.bg} text-white px-4 py-3 rounded-lg shadow-lg flex items-center toast-enter`;
        toast.innerHTML = `
            <i class="fas ${typeConfig.icon} mr-3"></i>
            <span class="flex-grow">${message}</span>
            <button onclick="removeToast('${toastId}')" class="ml-4 opacity-75 hover:opacity-100">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto-suppression après 5 secondes
        setTimeout(() => {
            removeToast(toastId);
        }, 5000);
    };
    
    /**
     * Supprimer un toast
     */
    window.removeToast = function(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.classList.remove('toast-enter');
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        }
    };
    
    /**
     * Afficher une erreur de chargement des commandes
     */
    window.showOrdersError = function(message) {
        const loading = document.getElementById('orders-loading');
        if (loading) {
            loading.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Erreur de chargement</h3>
                    <p class="text-gray-500 mb-4">${message}</p>
                    <button onclick="location.reload()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-300">
                        Réessayer
                    </button>
                </div>
            `;
        }
    };
    
    /**
     * Afficher les règles de livraison
     */
    window.displayDeliveryRules = function(rules) {
        const tbody = document.getElementById('delivery-rules-tbody');
        const container = document.getElementById('delivery-rules-container');
        const loading = document.getElementById('delivery-rules-loading');
        
        if (loading) loading.classList.add('hidden');
        
        if (!rules || rules.length === 0) {
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-truck-loading text-3xl mb-3 block"></i>
                            <p>Aucune règle de livraison configurée</p>
                            <p class="text-sm mt-2">Ajoutez votre première règle pour commencer</p>
                        </td>
                    </tr>
                `;
            }
        } else {
            let tableHTML = '';
            rules.forEach(rule => {
                tableHTML += `
                    <tr class="hover:bg-gray-50 transition-colors duration-200">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${rule.maxWeight} kg</div>
                        </td>
                        
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${FirebaseAdminModule.formatPrice(rule.fee)}</div>
                        </td>
                        
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${FirebaseAdminModule.formatPrice(rule.fragileExtraFee || 0)}</div>
                        </td>
                        
                        <td class="px-6 py-4">
                            <div class="text-gray-700">${rule.description || 'Pas de description'}</div>
                        </td>
                        
                        <td class="px-6 py-4">
                            <div class="flex space-x-2">
                                <button 
                                    onclick="editDeliveryRule('${rule.id}')"
                                    class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors duration-200"
                                    title="Modifier"
                                >
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button 
                                    onclick="confirmDeleteDeliveryRule('${rule.id}', ${rule.maxWeight})"
                                    class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200"
                                    title="Supprimer"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            if (tbody) tbody.innerHTML = tableHTML;
        }
        
        if (container) {
            container.classList.remove('hidden');
        }
    };
    
    /**
     * Afficher les points de rencontre
     */
    window.displayMeetingPoints = function(points) {
        const container = document.getElementById('meeting-points-container');
        const loading = document.getElementById('meeting-points-loading');
        
        if (loading) loading.classList.add('hidden');
        if (!container) return;
        
        if (!points || points.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-map-marker-alt text-3xl mb-3 block"></i>
                    <p>Aucun point de rencontre configuré</p>
                    <p class="text-sm mt-2">Ajoutez votre premier point de rencontre</p>
                </div>
            `;
        } else {
            let pointsHTML = '';
            points.forEach(point => {
                pointsHTML += `
                    <div class="bg-gray-50 rounded-lg p-4 hover-card">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h4 class="font-medium text-gray-800 flex items-center">
                                    ${point.name}
                                    ${point.isActive ? '' : '<span class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 text-xs rounded">Inactif</span>'}
                                </h4>
                                <p class="text-gray-600 text-sm mt-1">${point.address}</p>
                                ${point.description ? `<p class="text-gray-500 text-xs mt-2">${point.description}</p>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="toggleMeetingPointActive('${point.id}', ${!point.isActive})"
                                    class="p-2 ${point.isActive ? 'text-yellow-600 hover:bg-yellow-50' : 'text-green-600 hover:bg-green-50'} rounded-lg transition-colors duration-200"
                                    title="${point.isActive ? 'Désactiver' : 'Activer'}"
                                >
                                    <i class="fas ${point.isActive ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                </button>
                                <button 
                                    onclick="editMeetingPoint('${point.id}')"
                                    class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors duration-200"
                                    title="Modifier"
                                >
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button 
                                    onclick="confirmDeleteMeetingPoint('${point.id}', '${point.name}')"
                                    class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200"
                                    title="Supprimer"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = pointsHTML;
        }
        
        container.classList.remove('hidden');
    };
    
    /**
     * Afficher les magasins
     */
    window.displayStoreLocations = function(locations) {
        const container = document.getElementById('store-locations-container');
        const loading = document.getElementById('store-locations-loading');
        
        if (loading) loading.classList.add('hidden');
        if (!container) return;
        
        if (!locations || locations.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-store text-3xl mb-3 block"></i>
                    <p>Aucun magasin configuré</p>
                    <p class="text-sm mt-2">Ajoutez votre premier magasin</p>
                </div>
            `;
        } else {
            let locationsHTML = '';
            locations.forEach(store => {
                locationsHTML += `
                    <div class="bg-gray-50 rounded-lg p-4 hover-card">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h4 class="font-medium text-gray-800 flex items-center">
                                    ${store.name}
                                    ${store.isActive ? '' : '<span class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 text-xs rounded">Inactif</span>'}
                                </h4>
                                <p class="text-gray-600 text-sm mt-1">${store.address}</p>
                                <p class="text-gray-500 text-xs mt-2">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${store.openingHours}
                                </p>
                                ${store.phone ? `<p class="text-gray-500 text-xs mt-1"><i class="fas fa-phone mr-1"></i> ${store.phone}</p>` : ''}
                                ${store.description ? `<p class="text-gray-500 text-xs mt-2">${store.description}</p>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="toggleStoreLocationActive('${store.id}', ${!store.isActive})"
                                    class="p-2 ${store.isActive ? 'text-yellow-600 hover:bg-yellow-50' : 'text-green-600 hover:bg-green-50'} rounded-lg transition-colors duration-200"
                                    title="${store.isActive ? 'Désactiver' : 'Activer'}"
                                >
                                    <i class="fas ${store.isActive ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                </button>
                                <button 
                                    onclick="editStoreLocation('${store.id}')"
                                    class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors duration-200"
                                    title="Modifier"
                                >
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button 
                                    onclick="confirmDeleteStoreLocation('${store.id}', '${store.name}')"
                                    class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200"
                                    title="Supprimer"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = locationsHTML;
        }
        
        container.classList.remove('hidden');
    };
    
    /**
     * Cacher l'état de chargement des règles
     */
    window.hideDeliveryRulesLoading = function() {
        const loading = document.getElementById('delivery-rules-loading');
        if (loading) {
            loading.classList.add('hidden');
        }
    };
    
    /**
     * Cacher l'état de chargement des points de rencontre
     */
    window.hideMeetingPointsLoading = function() {
        const loading = document.getElementById('meeting-points-loading');
        if (loading) {
            loading.classList.add('hidden');
        }
    };
    
    /**
     * Cacher l'état de chargement des magasins
     */
    window.hideStoreLocationsLoading = function() {
        const loading = document.getElementById('store-locations-loading');
        if (loading) {
            loading.classList.add('hidden');
        }
    };
    
    /**
     * Cacher l'état de chargement des commandes
     */
    window.hideOrdersLoading = function() {
        const loading = document.getElementById('orders-loading');
        if (loading) {
            loading.classList.add('hidden');
        }
    };
    
    /**
     * Afficher les commandes dans le tableau
     */
    window.displayOrders = function(orders) {
        const tbody = document.getElementById('orders-tbody');
        const emptyState = document.getElementById('orders-empty');
        const tableContainer = document.getElementById('orders-table-container');
        const loading = document.getElementById('orders-loading');
        
        if (loading) loading.classList.add('hidden');
        
        if (!orders || orders.length === 0) {
            if (emptyState) emptyState.classList.remove('hidden');
            if (tableContainer) tableContainer.classList.add('hidden');
            return;
        }
        
        let tableHTML = '';
        orders.forEach(order => {
            // Détection du type de livraison adaptée à votre structure
            let deliveryType = 'Inconnu';
            let deliveryLocation = 'N/A';
            
            if (order.deliveryMethod === 'meeting_point' && order.selectedMeetingPoint) {
                deliveryType = 'Point de rencontre';
                deliveryLocation = order.selectedMeetingPoint.name || order.selectedMeetingPoint.address;
            } else if (order.deliveryMethod === 'store_pickup' && order.selectedStoreLocation) {
                deliveryType = 'Retrait magasin';
                deliveryLocation = order.selectedStoreLocation.name;
            } else if (order.deliveryMethod === 'home_delivery') {
                deliveryType = 'Domicile';
                deliveryLocation = order.customerInfo?.address || 'Adresse non spécifiée';
            }
            
            // Détection du statut adaptée
            const statusInfo = OrderManager.getStatusInfo(order.status);
            
            tableHTML += `
                <tr class="hover-card hover:bg-gray-50 transition-colors duration-200 cursor-pointer" onclick="openOrderDetail('${order.id}')">
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${order.orderCode || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${FirebaseAdminModule.formatDate(order.createdAt)}</div>
                    </td>
                    
                    <td class="px-6 py-4">
                        <div class="text-gray-900">${FirebaseAdminModule.formatDate(order.createdAt)}</div>
                    </td>
                    
                    <td class="px-6 py-4">
                        <div class="text-gray-900">${order.customerInfo?.name || 'Client sans nom'}</div>
                        <div class="text-sm text-gray-500">${order.items?.length || 0} article(s)</div>
                    </td>
                    
                    <td class="px-6 py-4">
                        <div class="text-gray-900">${deliveryType}</div>
                        <div class="text-sm text-gray-500">${deliveryLocation}</div>
                    </td>
                    
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${FirebaseAdminModule.formatPrice(order.totalAmount)}</div>
                        <div class="text-sm text-gray-500">Sous-total: ${FirebaseAdminModule.formatPrice(order.subtotal)}</div>
                    </td>
                    
                    <td class="px-6 py-4">
                        <span class="${statusInfo.class} status-badge">
                            ${statusInfo.text}
                        </span>
                    </td>
                    
                    <td class="px-6 py-4">
                        <button 
                            onclick="event.stopPropagation(); openOrderDetail('${order.id}')"
                            class="px-3 py-1 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded text-sm font-medium transition-colors duration-200"
                        >
                            Détails
                        </button>
                    </td>
                </tr>
            `;
        });
        
        if (tbody) tbody.innerHTML = tableHTML;
        if (emptyState) emptyState.classList.add('hidden');
        if (tableContainer) tableContainer.classList.remove('hidden');
    };
    
    // ============================================
    // MODULE 1: INITIALISATION FIREBASE
    // ============================================
    const FirebaseAdminModule = (() => {
        let firebaseApp = null;
        let firestoreDb = null;
        
        /**
         * Initialiser Firebase
         */
        const initializeFirebase = () => {
            try {
                debugLog('Initialisation de Firebase...');
                
                // Vérifier si Firebase est déjà chargé
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK non chargé');
                }
                
                // Initialiser l'app si pas déjà fait
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    debugLog('Firebase app initialisée');
                } else {
                    firebaseApp = firebase.app();
                    debugLog('Firebase app déjà existante');
                }
                
                // Récupérer Firestore
                firestoreDb = firebase.firestore();
                
                debugLog('✅ Firebase Commandes initialisé');
                return true;
            } catch (error) {
                console.error('❌ Erreur d\'initialisation Firebase:', error);
                showToast('Erreur de connexion à la base de données: ' + error.message, 'error');
                return false;
            }
        };
        
        /**
         * Obtenir l'instance Firestore
         */
        const getFirestore = () => {
            if (!firestoreDb) {
                if (!initializeFirebase()) {
                    throw new Error('Firebase non initialisé');
                }
            }
            return firestoreDb;
        };
        
        /**
         * Formater un prix
         */
        const formatPrice = (price) => {
            if (!price && price !== 0) return '0 HTG';
            return new Intl.NumberFormat('fr-HT', {
                style: 'currency',
                currency: 'HTG',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(price);
        };
        
        /**
         * Formater une date
         */
        const formatDate = (timestamp) => {
            if (!timestamp) return '--/--/----';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                debugLog('Erreur formatage date:', error);
                return 'Date invalide';
            }
        };
        
        /**
         * Vérifier et créer les collections si elles n'existent pas
         */
        const initializeCollections = async () => {
            try {
                debugLog('Initialisation des collections...');
                const db = getFirestore();
                
                // Créer des règles de livraison par défaut si la collection est vide
                const rulesSnapshot = await db.collection('delivery_rules').limit(1).get();
                if (rulesSnapshot.empty) {
                    debugLog('📦 Création des règles de livraison par défaut...');
                    
                    const defaultRules = [
                        {
                            maxWeight: 2,
                            fee: 100,
                            fragileExtraFee: 50,
                            description: 'Petits colis légers',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            maxWeight: 5,
                            fee: 200,
                            fragileExtraFee: 75,
                            description: 'Colis moyens',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            maxWeight: 10,
                            fee: 350,
                            fragileExtraFee: 100,
                            description: 'Gros colis',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            maxWeight: 20,
                            fee: 500,
                            fragileExtraFee: 150,
                            description: 'Colis très lourds',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    ];
                    
                    for (const rule of defaultRules) {
                        await db.collection('delivery_rules').add(rule);
                    }
                    
                    debugLog('✅ Règles de livraison par défaut créées');
                }
                
                // Créer des points de rencontre par défaut
                const pointsSnapshot = await db.collection('meeting_points').limit(1).get();
                if (pointsSnapshot.empty) {
                    debugLog('📍 Création des points de rencontre par défaut...');
                    
                    const defaultPoints = [
                        {
                            name: 'Place du Marché',
                            address: 'Marché en Fer, Port-au-Prince',
                            description: 'Devant l\'entrée principale',
                            isActive: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            name: 'Pétion-Ville Centre',
                            address: 'Place Saint-Pierre, Pétion-Ville',
                            description: 'À côté de l\'église',
                            isActive: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    ];
                    
                    for (const point of defaultPoints) {
                        await db.collection('meeting_points').add(point);
                    }
                    
                    debugLog('✅ Points de rencontre par défaut créés');
                }
                
                // Créer des magasins par défaut
                const storesSnapshot = await db.collection('store_locations').limit(1).get();
                if (storesSnapshot.empty) {
                    debugLog('🏪 Création des magasins par défaut...');
                    
                    const defaultStores = [
                        {
                            name: 'IZI-PRET Centre-Ville',
                            address: '123 Rue du Commerce, Port-au-Prince',
                            openingHours: 'Lundi-Vendredi: 8h-18h, Samedi: 9h-16h',
                            phone: '+509 44 44 4444',
                            description: 'Magasin principal',
                            isActive: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            name: 'IZI-PRET Pétion-Ville',
                            address: '456 Rue Lamartinière, Pétion-Ville',
                            openingHours: 'Lundi-Samedi: 9h-17h',
                            phone: '+509 44 44 4445',
                            description: 'Succursale',
                            isActive: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    ];
                    
                    for (const store of defaultStores) {
                        await db.collection('store_locations').add(store);
                    }
                    
                    debugLog('✅ Magasins par défaut créés');
                }
                
                debugLog('✅ Collections initialisées avec succès');
                return true;
                
            } catch (error) {
                console.error('❌ Erreur d\'initialisation des collections:', error);
                showToast('Erreur lors de l\'initialisation des données', 'warning');
                return false;
            }
        };
        
        return {
            initializeFirebase,
            getFirestore,
            formatPrice,
            formatDate,
            initializeCollections
        };
    })();
    
    // ============================================
    // MODULE 2: GESTION DES COMMANDES (CORRIGÉ POUR VOTRE STRUCTURE)
    // ============================================
    const OrderManager = (() => {
        /**
         * Charger les commandes en temps réel adapté à votre structure
         */
        const loadOrdersRealtime = () => {
            try {
                const db = FirebaseAdminModule.getFirestore();
                debugLog('Chargement des commandes en temps réel...');
                
                // Arrêter les écouteurs précédents
                Object.values(adminState.orderListeners).forEach(unsubscribe => {
                    if (unsubscribe) unsubscribe();
                });
                
                // Charger TOUTES les commandes par date de création
                adminState.orderListeners.all = db.collection('orders')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(
                        (snapshot) => {
                            debugLog('Snapshot reçu:', { size: snapshot.size });
                            const allOrders = [];
                            const stats = { 
                                pending: 0, 
                                confirmed: 0, 
                                delivered: 0, 
                                cancelled: 0, 
                                total: 0,
                                pending_payment: 0,
                                processing: 0
                            };
                            
                            snapshot.forEach(doc => {
                                const order = {
                                    id: doc.id,
                                    ...doc.data()
                                };
                                allOrders.push(order);
                                
                                // Mettre à jour les statistiques selon votre structure
                                const status = order.status || 'unknown';
                                if (status.includes('pending')) stats.pending_payment++;
                                else if (status.includes('processing')) stats.processing++;
                                else if (status.includes('confirmed') || status === 'confirmed') stats.confirmed++;
                                else if (status.includes('delivered') || status === 'delivered') stats.delivered++;
                                else if (status.includes('cancelled') || status === 'cancelled') stats.cancelled++;
                                
                                // Pour compatibilité avec l'ancienne structure
                                if (status === 'pending_payment') stats.pending++;
                                
                                stats.total++;
                            });
                            
                            adminState.allOrders = allOrders;
                            adminState.stats = stats;
                            
                            debugLog('Commandes chargées:', { 
                                total: allOrders.length, 
                                stats 
                            });
                            
                            // Filtrer les commandes actives (pending_payment, processing, confirmed)
                            const activeOrders = allOrders.filter(order => {
                                const status = order.status || 'unknown';
                                return status.includes('pending') || 
                                       status.includes('processing') || 
                                       status.includes('confirmed') ||
                                       status === 'confirmed';
                            });
                            
                            adminState.orders = activeOrders;
                            
                            // Appliquer le filtre actuel
                            applyOrderFilter();
                            
                            // Mettre à jour les compteurs UI
                            updateOrderCounters();
                            updateNotificationBadge();
                            
                            // Cacher l'état de chargement
                            hideOrdersLoading();
                            
                            // Mettre à jour l'heure de synchronisation
                            updateLastSyncTime();
                        },
                        (error) => {
                            console.error('❌ Erreur de chargement des commandes:', error);
                            showOrdersError('Impossible de charger les commandes: ' + error.message);
                        }
                    );
            } catch (error) {
                console.error('❌ Erreur dans loadOrdersRealtime:', error);
                showOrdersError('Erreur de chargement: ' + error.message);
            }
        };
        
        /**
         * Mettre à jour les compteurs de commandes
         */
        const updateOrderCounters = () => {
            const stats = adminState.stats;
            
            const pendingEl = document.getElementById('pending-orders-count');
            const confirmedEl = document.getElementById('confirmed-orders-count');
            const deliveredEl = document.getElementById('delivered-orders-count');
            const totalEl = document.getElementById('total-orders-count');
            const activeEl = document.getElementById('active-orders-count');
            
            if (pendingEl) pendingEl.textContent = stats.pending_payment + stats.processing;
            if (confirmedEl) confirmedEl.textContent = stats.confirmed;
            if (deliveredEl) deliveredEl.textContent = stats.delivered;
            if (totalEl) totalEl.textContent = stats.total;
            if (activeEl) activeEl.textContent = stats.pending_payment + stats.processing + stats.confirmed;
            
            debugLog('Compteurs mis à jour:', stats);
        };
        
        /**
         * Mettre à jour le badge de notification
         */
        const updateNotificationBadge = () => {
            const pendingCount = adminState.stats.pending_payment;
            const badge = document.getElementById('pending-count');
            
            if (badge) {
                if (pendingCount > 0) {
                    badge.textContent = pendingCount > 99 ? '99+' : pendingCount;
                    badge.classList.remove('hidden');
                    badge.classList.add('pulse');
                } else {
                    badge.classList.add('hidden');
                    badge.classList.remove('pulse');
                }
            }
        };
        
        /**
         * Mettre à jour l'heure de synchronisation
         */
        const updateLastSyncTime = () => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const syncEl = document.getElementById('last-sync');
            if (syncEl) {
                syncEl.textContent = timeString;
            }
        };
        
        /**
         * Appliquer le filtre de commandes
         */
        const applyOrderFilter = () => {
            let filtered = [...adminState.orders];
            
            if (adminState.currentOrderFilter !== 'all') {
                filtered = filtered.filter(order => {
                    const status = order.status || 'unknown';
                    if (adminState.currentOrderFilter === 'pending') {
                        return status.includes('pending');
                    } else if (adminState.currentOrderFilter === 'confirmed') {
                        return status.includes('confirmed') || status === 'confirmed';
                    } else if (adminState.currentOrderFilter === 'processing') {
                        return status.includes('processing');
                    }
                    return false;
                });
            }
            
            adminState.filteredOrders = filtered;
            displayOrders(filtered);
            
            debugLog('Filtre appliqué:', { 
                filter: adminState.currentOrderFilter, 
                resultCount: filtered.length 
            });
        };
        
        /**
         * Mettre à jour le statut d'une commande adapté à votre structure
         */
        const updateOrderStatus = async (orderId, newStatus) => {
            try {
                debugLog(`Mise à jour statut commande ${orderId} -> ${newStatus}`);
                const db = FirebaseAdminModule.getFirestore();
                
                const updateData = {
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Ajouter des timestamps spécifiques
                if (newStatus === 'delivered') {
                    updateData.deliveredAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                if (newStatus === 'confirmed') {
                    updateData.confirmedAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                if (newStatus === 'cancelled') {
                    updateData.cancelledAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                if (newStatus === 'processing') {
                    updateData.processingAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                await db.collection('orders').doc(orderId).update(updateData);
                
                const statusInfo = getStatusInfo(newStatus);
                showToast(`✅ Commande marquée comme ${statusInfo.text.toLowerCase()}`, 'success');
                
                // Fermer le modal de détail si ouvert
                closeOrderDetailModal();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de mise à jour du statut:', error);
                showToast('Erreur lors de la mise à jour du statut: ' + error.message, 'error');
                return false;
            }
        };
        
        /**
         * Vérifier un code de commande
         */
        const verifyOrderCode = async (orderCode) => {
            try {
                debugLog(`Vérification code commande: ${orderCode}`);
                const db = FirebaseAdminModule.getFirestore();
                
                // Rechercher la commande par orderCode (insensible à la casse)
                const snapshot = await db.collection('orders')
                    .where('orderCode', '==', orderCode.toUpperCase())
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    debugLog('Code non trouvé');
                    return { found: false, message: 'Code de commande invalide' };
                }
                
                const doc = snapshot.docs[0];
                const order = {
                    id: doc.id,
                    ...doc.data()
                };
                
                debugLog('Commande trouvée:', order.id);
                return { found: true, order };
                
            } catch (error) {
                console.error('❌ Erreur de vérification du code:', error);
                return { found: false, message: 'Erreur lors de la vérification' };
            }
        };
        
        /**
         * Obtenir les informations de statut adaptées à votre structure
         */
        const getStatusInfo = (status) => {
            const statusMap = {
                'pending_payment': { text: 'Paiement en attente', class: 'status-pending' },
                'pending': { text: 'En attente', class: 'status-pending' },
                'processing': { text: 'En traitement', class: 'status-confirmed' },
                'confirmed': { text: 'Confirmée', class: 'status-confirmed' },
                'delivered': { text: 'Livrée', class: 'status-delivered' },
                'cancelled': { text: 'Annulée', class: 'status-cancelled' },
                'shipped': { text: 'Expédiée', class: 'status-confirmed' },
                'completed': { text: 'Terminée', class: 'status-delivered' }
            };
            
            return statusMap[status] || { text: status || 'Inconnu', class: 'status-pending' };
        };
        
        /**
         * Obtenir le texte du statut (pour compatibilité)
         */
        const getStatusText = (status) => {
            return getStatusInfo(status).text;
        };
        
        /**
         * Obtenir la classe CSS du statut (pour compatibilité)
         */
        const getStatusClass = (status) => {
            return getStatusInfo(status).class;
        };
        
        /**
         * Afficher le résultat de vérification adapté à votre structure
         */
        const displayVerificationResult = (result) => {
            const container = document.getElementById('verification-result');
            if (!container) return;
            
            if (!result.found) {
                container.innerHTML = `
                    <div class="bg-white rounded-xl shadow-md p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Code non trouvé</h3>
                        <p class="text-gray-500 mb-6">${result.message}</p>
                        <p class="text-sm text-gray-500">Vérifiez le code et réessayez.</p>
                    </div>
                `;
            } else {
                const order = result.order;
                const statusInfo = getStatusInfo(order.status);
                
                // Détection du type de livraison
                let deliveryType = 'Inconnu';
                if (order.deliveryMethod === 'meeting_point') {
                    deliveryType = 'Point de rencontre';
                } else if (order.deliveryMethod === 'store_pickup') {
                    deliveryType = 'Retrait magasin';
                } else if (order.deliveryMethod === 'home_delivery') {
                    deliveryType = 'Domicile';
                }
                
                // Détection du mode de paiement
                let paymentMethod = 'À la rencontre';
                if (order.paymentMethod === 'in_person') {
                    paymentMethod = 'À la rencontre';
                } else if (order.paymentMethod === 'moncash') {
                    paymentMethod = 'MonCash';
                } else if (order.paymentMethod === 'credit_card') {
                    paymentMethod = 'Carte de crédit';
                }
                
                container.innerHTML = `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">Commande vérifiée</h3>
                                    <p class="text-gray-600">${order.orderCode} • ${FirebaseAdminModule.formatDate(order.createdAt)}</p>
                                </div>
                                <span class="${statusInfo.class} status-badge text-base">
                                    ${statusInfo.text}
                                </span>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <h4 class="font-medium text-gray-800 mb-3">Informations client</h4>
                                    <div class="space-y-2">
                                        <p class="text-gray-600">
                                            <i class="fas fa-user mr-3 w-5"></i>
                                            <span class="font-medium">Nom:</span> ${order.customerInfo?.name || 'Non spécifié'}
                                        </p>
                                        <p class="text-gray-600">
                                            <i class="fas fa-phone mr-3 w-5"></i>
                                            <span class="font-medium">Téléphone:</span> ${order.customerInfo?.phone || 'Non spécifié'}
                                        </p>
                                        <p class="text-gray-600">
                                            <i class="fas fa-envelope mr-3 w-5"></i>
                                            <span class="font-medium">Email:</span> ${order.customerInfo?.email || 'Non spécifié'}
                                        </p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-medium text-gray-800 mb-3">Détails commande</h4>
                                    <div class="space-y-2">
                                        <p class="text-gray-600">
                                            <i class="fas fa-boxes mr-3 w-5"></i>
                                            <span class="font-medium">Articles:</span> ${order.items?.length || 0}
                                        </p>
                                        <p class="text-gray-600">
                                            <i class="fas fa-truck mr-3 w-5"></i>
                                            <span class="font-medium">Livraison:</span> ${deliveryType}
                                        </p>
                                        <p class="text-gray-600">
                                            <i class="fas fa-credit-card mr-3 w-5"></i>
                                            <span class="font-medium">Paiement:</span> ${paymentMethod}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <h4 class="font-medium text-gray-800 mb-3">Montants</h4>
                                    <div class="space-y-2">
                                        <p class="text-gray-600">
                                            <span class="font-medium">Sous-total:</span> 
                                            ${FirebaseAdminModule.formatPrice(order.subtotal || 0)}
                                        </p>
                                        ${order.totalWeight ? `
                                            <p class="text-gray-600">
                                                <span class="font-medium">Poids total:</span> 
                                                ${order.totalWeight} kg
                                            </p>
                                        ` : ''}
                                        <p class="text-gray-600 font-bold text-lg">
                                            <span class="font-medium">Total:</span> 
                                            ${FirebaseAdminModule.formatPrice(order.totalAmount || 0)}
                                        </p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-medium text-gray-800 mb-3">Actions disponibles</h4>
                                    <div class="space-y-2">
                                        ${order.status === 'pending_payment' || order.status === 'pending' ? `
                                            <p class="text-sm text-gray-600">
                                                Cette commande attend le paiement.
                                            </p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex space-x-4">
                                ${order.status === 'pending_payment' || order.status === 'pending' ? `
                                    <button 
                                        onclick="updateOrderStatus('${order.id}', 'processing')"
                                        class="flex-grow py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center"
                                    >
                                        <i class="fas fa-cog mr-2"></i>
                                        Marquer comme en traitement
                                    </button>
                                ` : order.status === 'processing' ? `
                                    <button 
                                        onclick="updateOrderStatus('${order.id}', 'confirmed')"
                                        class="flex-grow py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center"
                                    >
                                        <i class="fas fa-check-circle mr-2"></i>
                                        Marquer comme confirmée
                                    </button>
                                ` : order.status === 'confirmed' ? `
                                    <button 
                                        onclick="updateOrderStatus('${order.id}', 'delivered')"
                                        class="flex-grow py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center"
                                    >
                                        <i class="fas fa-shipping-fast mr-2"></i>
                                        Marquer comme livrée
                                    </button>
                                ` : `
                                    <div class="flex-grow py-3 bg-gray-100 text-gray-500 font-medium rounded-lg flex items-center justify-center">
                                        <i class="fas fa-lock mr-2"></i>
                                        ${statusInfo.text}
                                    </div>
                                `}
                                
                                <button 
                                    onclick="openOrderDetail('${order.id}')"
                                    class="px-6 py-3 border border-indigo-600 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors duration-300"
                                >
                                    <i class="fas fa-eye mr-2"></i>
                                    Détails complets
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });
        };
        
        /**
         * Afficher l'historique adapté à votre structure
         */
        const displayHistory = (orders) => {
            const tbody = document.getElementById('history-tbody');
            const container = document.getElementById('history-table-container');
            const loading = document.getElementById('history-loading');
            
            if (loading) loading.classList.add('hidden');
            
            if (!orders || orders.length === 0) {
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-history text-3xl mb-3 block"></i>
                                <p>Aucune commande trouvée</p>
                                <p class="text-sm mt-2">Modifiez vos critères de recherche</p>
                            </td>
                        </tr>
                    `;
                }
            } else {
                let tableHTML = '';
                orders.forEach(order => {
                    const statusInfo = getStatusInfo(order.status);
                    const customerName = order.customerInfo?.name || 'Client sans nom';
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900">${order.orderCode || 'N/A'}</div>
                            </td>
                            
                            <td class="px-6 py-4">
                                <div class="text-gray-900">${FirebaseAdminModule.formatDate(order.createdAt)}</div>
                            </td>
                            
                            <td class="px-6 py-4">
                                <div class="text-gray-900">${customerName}</div>
                                <div class="text-sm text-gray-500">${order.customerInfo?.phone || 'N/A'}</div>
                            </td>
                            
                            <td class="px-6 py-4">
                                <div class="text-gray-900">${order.items?.length || 0} article(s)</div>
                            </td>
                            
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900">${FirebaseAdminModule.formatPrice(order.totalAmount || 0)}</div>
                            </td>
                            
                            <td class="px-6 py-4">
                                <span class="${statusInfo.class} status-badge">
                                    ${statusInfo.text}
                                </span>
                            </td>
                            
                            <td class="px-6 py-4">
                                <button 
                                    onclick="openOrderDetail('${order.id}')"
                                    class="px-3 py-1 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded text-sm font-medium transition-colors duration-200"
                                >
                                    <i class="fas fa-eye mr-1"></i>
                                    Voir
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                if (tbody) tbody.innerHTML = tableHTML;
            }
            
            if (container) container.classList.remove('hidden');
        };
        
        /**
         * Appliquer le filtre d'historique adapté à votre structure
         */
        const applyHistoryFilter = () => {
            let filtered = [...adminState.allOrders];
            
            // Filtrer par statut
            if (adminState.currentHistoryFilter !== 'all') {
                filtered = filtered.filter(order => {
                    const status = order.status || 'unknown';
                    if (adminState.currentHistoryFilter === 'pending') {
                        return status.includes('pending');
                    } else if (adminState.currentHistoryFilter === 'confirmed') {
                        return status.includes('confirmed') || status === 'confirmed';
                    } else if (adminState.currentHistoryFilter === 'delivered') {
                        return status.includes('delivered') || status === 'delivered';
                    } else if (adminState.currentHistoryFilter === 'cancelled') {
                        return status.includes('cancelled') || status === 'cancelled';
                    } else if (adminState.currentHistoryFilter === 'processing') {
                        return status.includes('processing');
                    }
                    return false;
                });
            }
            
            // Filtrer par date
            const dateFrom = document.getElementById('history-date-from')?.value;
            const dateTo = document.getElementById('history-date-to')?.value;
            
            if (dateFrom || dateTo) {
                filtered = filtered.filter(order => {
                    try {
                        const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                        const fromDate = dateFrom ? new Date(dateFrom) : null;
                        const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null; // Jusqu'à la fin de la journée
                        
                        if (fromDate && orderDate < fromDate) return false;
                        if (toDate && orderDate > toDate) return false;
                        
                        return true;
                    } catch (error) {
                        console.error('Erreur de filtrage date:', error);
                        return true; // Garder la commande en cas d'erreur
                    }
                });
            }
            
            debugLog('Historique filtré:', { 
                filter: adminState.currentHistoryFilter,
                dateFrom, 
                dateTo, 
                count: filtered.length 
            });
            
            displayHistory(filtered);
        };
        
        return {
            loadOrdersRealtime,
            applyOrderFilter,
            updateOrderStatus,
            verifyOrderCode,
            getStatusText,
            getStatusClass,
            getStatusInfo,
            displayVerificationResult,
            applyHistoryFilter
        };
    })();
    
    // ============================================
    // MODULE 3: GESTION DES RÈGLES DE LIVRAISON
    // ============================================
    const DeliveryRulesManager = (() => {
        /**
         * Charger les règles de livraison
         */
        const loadDeliveryRules = async () => {
            try {
                debugLog('Chargement des règles de livraison...');
                const db = FirebaseAdminModule.getFirestore();
                const snapshot = await db.collection('delivery_rules')
                    .orderBy('maxWeight')
                    .get();
                
                const rules = [];
                snapshot.forEach(doc => {
                    rules.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                adminState.deliveryRules = rules;
                displayDeliveryRules(rules);
                
                debugLog(`Règles chargées: ${rules.length}`);
                return rules;
                
            } catch (error) {
                console.error('❌ Erreur de chargement des règles:', error);
                showToast('Erreur de chargement des règles de livraison: ' + error.message, 'error');
                return [];
            }
        };
        
        /**
         * Créer ou mettre à jour une règle
         */
        const saveDeliveryRule = async (ruleData, ruleId = null) => {
            try {
                debugLog('Sauvegarde règle de livraison:', { ruleId, ruleData });
                const db = FirebaseAdminModule.getFirestore();
                
                // Validation
                if (!ruleData.maxWeight || ruleData.maxWeight <= 0) {
                    throw new Error('Le poids maximum doit être positif');
                }
                
                if (ruleData.fee === undefined || ruleData.fee < 0 || isNaN(ruleData.fee)) {
                    throw new Error('Les frais doivent être positifs ou nuls');
                }
                
                // Préparer les données
                const rule = {
                    maxWeight: parseFloat(ruleData.maxWeight),
                    fee: parseFloat(ruleData.fee),
                    fragileExtraFee: parseFloat(ruleData.fragileExtraFee || 0),
                    description: ruleData.description || '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                debugLog('Règle préparée:', rule);
                
                if (ruleId) {
                    // Mettre à jour une règle existante
                    await db.collection('delivery_rules').doc(ruleId).update(rule);
                    showToast('✅ Règle mise à jour avec succès', 'success');
                    debugLog('Règle mise à jour:', ruleId);
                } else {
                    // Créer une nouvelle règle
                    rule.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await db.collection('delivery_rules').add(rule);
                    showToast('✅ Règle créée avec succès', 'success');
                    debugLog('Règle créée:', docRef.id);
                }
                
                // Recharger les règles
                await loadDeliveryRules();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de sauvegarde de la règle:', error);
                showToast(`Erreur: ${error.message}`, 'error');
                return false;
            }
        };
        
        /**
         * Supprimer une règle
         */
        const deleteDeliveryRule = async (ruleId) => {
            try {
                debugLog('Suppression règle:', ruleId);
                const db = FirebaseAdminModule.getFirestore();
                await db.collection('delivery_rules').doc(ruleId).delete();
                
                showToast('✅ Règle supprimée avec succès', 'success');
                
                // Recharger les règles
                await loadDeliveryRules();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de suppression de la règle:', error);
                showToast('Erreur lors de la suppression: ' + error.message, 'error');
                return false;
            }
        };
        
        return {
            loadDeliveryRules,
            saveDeliveryRule,
            deleteDeliveryRule
        };
    })();
    
    // ============================================
    // MODULE 4: GESTION DES LIEUX DE LIVRAISON
    // ============================================
    const LocationsManager = (() => {
        /**
         * Charger les points de rencontre
         */
        const loadMeetingPoints = async () => {
            try {
                debugLog('Chargement des points de rencontre...');
                const db = FirebaseAdminModule.getFirestore();
                const snapshot = await db.collection('meeting_points')
                    .orderBy('name')
                    .get();
                
                const points = [];
                snapshot.forEach(doc => {
                    points.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                adminState.meetingPoints = points;
                displayMeetingPoints(points);
                
                debugLog(`Points de rencontre chargés: ${points.length}`);
                return points;
                
            } catch (error) {
                console.error('❌ Erreur de chargement des points de rencontre:', error);
                showToast('Erreur de chargement des points de rencontre: ' + error.message, 'error');
                return [];
            }
        };
        
        /**
         * Charger les magasins
         */
        const loadStoreLocations = async () => {
            try {
                debugLog('Chargement des magasins...');
                const db = FirebaseAdminModule.getFirestore();
                const snapshot = await db.collection('store_locations')
                    .orderBy('name')
                    .get();
                
                const locations = [];
                snapshot.forEach(doc => {
                    locations.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                adminState.storeLocations = locations;
                displayStoreLocations(locations);
                
                debugLog(`Magasins chargés: ${locations.length}`);
                return locations;
                
            } catch (error) {
                console.error('❌ Erreur de chargement des magasins:', error);
                showToast('Erreur de chargement des magasins: ' + error.message, 'error');
                return [];
            }
        };
        
        /**
         * Sauvegarder un point de rencontre
         */
     const saveMeetingPoint = async (pointData, pointId = null) => {
    try {
        debugLog('Sauvegarde point de rencontre:', { pointId, pointData });
        const db = FirebaseAdminModule.getFirestore();

        // ===============================
        // VALIDATIONS
        // ===============================
        if (!pointData.name || !pointData.name.trim()) {
            throw new Error('Le nom du point de rencontre est obligatoire');
        }

        if (!pointData.address || !pointData.address.trim()) {
            throw new Error('L\'adresse du point de rencontre est obligatoire');
        }

      const deliveryFee = Number(pointData.deliveryFee ?? 0);

        if (isNaN(deliveryFee) || deliveryFee < 0) {
            throw new Error('Les frais de livraison doivent être un nombre positif');
        }

        // ===============================
        // PRÉPARATION DES DONNÉES
        // ===============================
        const point = {
            name: pointData.name.trim(),
            address: pointData.address.trim(),
            description: pointData.description?.trim() || '',
            deliveryFee: Number(pointData.deliveryFee || 0), // ✅ ICI
            isActive: pointData.isActive !== false,
            coordinates: pointData.coordinates || null,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        debugLog('Point préparé:', point);

        // ===============================
        // FIRESTORE WRITE
        // ===============================
        if (pointId) {
            // Mise à jour
            await db.collection('meeting_points').doc(pointId).update(point);
            showToast('✅ Point de rencontre mis à jour', 'success');
            debugLog('Point mis à jour:', pointId);
        } else {
            // Création
            point.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            const docRef = await db.collection('meeting_points').add(point);
            showToast('✅ Point de rencontre créé', 'success');
            debugLog('Point créé:', docRef.id);
        }

        // ===============================
        // RELOAD UI
        // ===============================
        await loadMeetingPoints();

        return true;

    } catch (error) {
        console.error('❌ Erreur de sauvegarde du point:', error);
        showToast(`Erreur: ${error.message}`, 'error');
        return false;
    }
};

        /**
         * Sauvegarder un magasin
         */
        const saveStoreLocation = async (storeData, storeId = null) => {
            try {
                debugLog('Sauvegarde magasin:', { storeId, storeData });
                const db = FirebaseAdminModule.getFirestore();
                
                // Validation
                if (!storeData.name || !storeData.name.trim()) {
                    throw new Error('Le nom est obligatoire');
                }
                
                if (!storeData.address || !storeData.address.trim()) {
                    throw new Error('L\'adresse est obligatoire');
                }
                
                if (!storeData.openingHours || !storeData.openingHours.trim()) {
                    throw new Error('Les horaires d\'ouverture sont obligatoires');
                }
                
                // Préparer les données
                const store = {
                    name: storeData.name.trim(),
                    address: storeData.address.trim(),
                    openingHours: storeData.openingHours.trim(),
                    phone: storeData.phone || '',
                    description: storeData.description || '',
                    isActive: storeData.isActive !== false,
                    coordinates: storeData.coordinates || null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                debugLog('Magasin préparé:', store);
                
                if (storeId) {
                    // Mettre à jour un magasin existant
                    await db.collection('store_locations').doc(storeId).update(store);
                    showToast('✅ Magasin mis à jour', 'success');
                    debugLog('Magasin mis à jour:', storeId);
                } else {
                    // Créer un nouveau magasin
                    store.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await db.collection('store_locations').add(store);
                    showToast('✅ Magasin créé', 'success');
                    debugLog('Magasin créé:', docRef.id);
                }
                
                // Recharger les magasins
                await loadStoreLocations();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de sauvegarde du magasin:', error);
                showToast(`Erreur: ${error.message}`, 'error');
                return false;
            }
        };
        
        /**
         * Supprimer un point de rencontre
         */
        const deleteMeetingPoint = async (pointId) => {
            try {
                debugLog('Suppression point de rencontre:', pointId);
                const db = FirebaseAdminModule.getFirestore();
                await db.collection('meeting_points').doc(pointId).delete();
                
                showToast('✅ Point de rencontre supprimé', 'success');
                
                // Recharger les points
                await loadMeetingPoints();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de suppression du point:', error);
                showToast('Erreur lors de la suppression: ' + error.message, 'error');
                return false;
            }
        };
        
        /**
         * Supprimer un magasin
         */
        const deleteStoreLocation = async (storeId) => {
            try {
                debugLog('Suppression magasin:', storeId);
                const db = FirebaseAdminModule.getFirestore();
                await db.collection('store_locations').doc(storeId).delete();
                
                showToast('✅ Magasin supprimé', 'success');
                
                // Recharger les magasins
                await loadStoreLocations();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de suppression du magasin:', error);
                showToast('Erreur lors de la suppression: ' + error.message, 'error');
                return false;
            }
        };
        
        /**
         * Basculer l'activité d'un point de rencontre
         */
        const toggleMeetingPointActive = async (pointId, isActive) => {
            try {
                debugLog(`Toggle point ${pointId} -> ${isActive}`);
                const db = FirebaseAdminModule.getFirestore();
                await db.collection('meeting_points').doc(pointId).update({
                    isActive: isActive,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`✅ Point ${isActive ? 'activé' : 'désactivé'}`, 'success');
                
                // Recharger les points
                await loadMeetingPoints();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de changement d\'état:', error);
                showToast('Erreur lors du changement d\'état: ' + error.message, 'error');
                return false;
            }
        };
        
        /**
         * Basculer l'activité d'un magasin
         */
        const toggleStoreLocationActive = async (storeId, isActive) => {
            try {
                debugLog(`Toggle magasin ${storeId} -> ${isActive}`);
                const db = FirebaseAdminModule.getFirestore();
                await db.collection('store_locations').doc(storeId).update({
                    isActive: isActive,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`✅ Magasin ${isActive ? 'activé' : 'désactivé'}`, 'success');
                
                // Recharger les magasins
                await loadStoreLocations();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erreur de changement d\'état:', error);
                showToast('Erreur lors du changement d\'état: ' + error.message, 'error');
                return false;
            }
        };
        
        return {
            loadMeetingPoints,
            loadStoreLocations,
            saveMeetingPoint,
            saveStoreLocation,
            deleteMeetingPoint,
            deleteStoreLocation,
            toggleMeetingPointActive,
            toggleStoreLocationActive
        };
    })();
    
    // ============================================
    // MODULE 5: GESTION DES MODALS (CORRIGÉ POUR VOTRE STRUCTURE)
    // ============================================
    const ModalManager = (() => {
        /**
         * Ouvrir le modal de détail d'une commande adapté à votre structure
         */
        const openOrderDetail = async (orderId) => {
            // Chercher la commande dans toutes les commandes
            const order = adminState.allOrders.find(o => o.id === orderId);
            
            if (!order) {
                showToast('Commande non trouvée', 'error');
                return;
            }
            
            const modalContent = document.getElementById('order-detail-modal');
            if (!modalContent) return;
            
            // Obtenir les informations de statut
            const statusInfo = OrderManager.getStatusInfo(order.status);
            
            // Détection du type de livraison
            let deliveryType = 'Inconnu';
            let deliveryLocation = 'N/A';
            let deliveryDetails = '';
            
            if (order.deliveryMethod === 'meeting_point' && order.selectedMeetingPoint) {
                deliveryType = 'Point de rencontre';
                deliveryLocation = order.selectedMeetingPoint.name;
                deliveryDetails = `
                    <p class="text-gray-600 text-sm mt-1">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        ${order.selectedMeetingPoint.address}
                    </p>
                    ${order.selectedMeetingPoint.description ? `
                        <p class="text-gray-500 text-xs mt-1">
                            <i class="fas fa-info-circle mr-2"></i>
                            ${order.selectedMeetingPoint.description}
                        </p>
                    ` : ''}
                `;
            } else if (order.deliveryMethod === 'store_pickup' && order.selectedStoreLocation) {
                deliveryType = 'Retrait magasin';
                deliveryLocation = order.selectedStoreLocation.name;
                deliveryDetails = `
                    <p class="text-gray-600 text-sm mt-1">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        ${order.selectedStoreLocation.address}
                    </p>
                `;
            } else if (order.deliveryMethod === 'home_delivery' && order.customerInfo) {
                deliveryType = 'Domicile';
                deliveryLocation = order.customerInfo.address || 'Adresse non spécifiée';
            }
            
            // Détection du mode de paiement
            let paymentMethod = 'À la rencontre';
            let paymentDetails = '';
            if (order.paymentMethod === 'in_person') {
                paymentMethod = 'À la rencontre';
                paymentDetails = 'Paiement à la livraison';
            } else if (order.paymentMethod === 'moncash') {
                paymentMethod = 'MonCash';
                paymentDetails = 'Paiement mobile';
            }
            
            modalContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden relative z-10 order-detail-enter">
                    <!-- Modal Header -->
                    <div class="px-8 py-6 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">Commande ${order.orderCode || order.id.substring(0, 8)}</h3>
                                <p class="text-gray-600">${FirebaseAdminModule.formatDate(order.createdAt)}</p>
                            </div>
                            <button 
                                onclick="closeOrderDetailModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
                            >
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="overflow-y-auto max-h-[70vh] p-8">
                        <div class="grid md:grid-cols-3 gap-8 mb-8">
                            <!-- Order Info -->
                            <div class="md:col-span-2">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Informations de la commande</h4>
                                
                                <!-- Status -->
                                <div class="mb-6">
                                    <p class="text-sm text-gray-600 mb-2">Statut</p>
                                    <div class="flex items-center space-x-4">
                                        <span class="${statusInfo.class} status-badge text-base">
                                            ${statusInfo.text}
                                        </span>
                                        ${order.deliveredAt ? `
                                            <span class="text-gray-600">
                                                <i class="fas fa-calendar-check mr-2"></i>
                                                Livrée le: ${FirebaseAdminModule.formatDate(order.deliveredAt)}
                                            </span>
                                        ` : ''}
                                        ${order.confirmedAt ? `
                                            <span class="text-gray-600">
                                                <i class="fas fa-check-circle mr-2"></i>
                                                Confirmée le: ${FirebaseAdminModule.formatDate(order.confirmedAt)}
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <!-- Customer Info -->
                                <div class="mb-6">
                                    <p class="text-sm text-gray-600 mb-2">Informations client</p>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <p class="font-medium text-gray-800 mb-1">
                                                    <i class="fas fa-user mr-2"></i>
                                                    ${order.customerInfo?.name || 'Non spécifié'}
                                                </p>
                                                <p class="text-gray-600 text-sm">
                                                    <i class="fas fa-phone mr-2"></i>
                                                    ${order.customerInfo?.phone || 'Non spécifié'}
                                                </p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600 text-sm">
                                                    <i class="fas fa-envelope mr-2"></i>
                                                    ${order.customerInfo?.email || 'Non spécifié'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Delivery Info -->
                                <div class="mb-6">
                                    <p class="text-sm text-gray-600 mb-2">Livraison</p>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex items-start mb-2">
                                            <i class="fas fa-truck text-gray-400 mr-3 mt-1"></i>
                                            <div>
                                                <p class="font-medium text-gray-800">
                                                    ${deliveryType}
                                                </p>
                                                <p class="text-gray-600 text-sm">${deliveryLocation}</p>
                                                ${deliveryDetails}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payment Info -->
                                <div class="mb-6">
                                    <p class="text-sm text-gray-600 mb-2">Paiement</p>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex items-center">
                                            <i class="fas fa-credit-card text-gray-400 mr-3"></i>
                                            <div>
                                                <p class="font-medium text-gray-800">
                                                    ${paymentMethod}
                                                </p>
                                                <p class="text-gray-600 text-sm">
                                                    ${paymentDetails}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Products -->
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-3">Articles (${order.items?.length || 0})</h5>
                                    <div class="space-y-3">
                                        ${order.items ? order.items.map((item, index) => `
                                            <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                                                <div class="w-16 h-16 rounded overflow-hidden bg-gray-100 flex-shrink-0 mr-4">
                                                    <img 
                                                        src="${item.imageName || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                                                        alt="${item.name}"
                                                        class="w-full h-full object-cover"
                                                        onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'"
                                                    >
                                                </div>
                                                <div class="flex-grow">
                                                    <p class="font-medium text-gray-800">${item.name || 'Produit sans nom'}</p>
                                                    <p class="text-sm text-gray-600">Quantité: ${item.quantity || 1}</p>
                                                    <p class="text-sm text-gray-600">Poids: ${item.weight || 0} kg</p>
                                                    ${item.selectedOptions && Object.keys(item.selectedOptions).length > 0 ? `
                                                        <p class="text-xs text-gray-500 mt-1">
                                                            ${Object.entries(item.selectedOptions)
                                                                .filter(([key, value]) => value)
                                                                .map(([key, value]) => `${key}: ${value}`)
                                                                .join(' • ')}
                                                        </p>
                                                    ` : ''}
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-medium text-gray-800">${FirebaseAdminModule.formatPrice(item.finalPrice || 0)}</p>
                                                    <p class="text-sm text-gray-600">${FirebaseAdminModule.formatPrice(item.unitPrice || 0)} l'unité</p>
                                                    ${item.oldPrice && item.oldPrice > item.finalPrice ? `
                                                        <p class="text-xs text-green-600">
                                                            Économie: ${FirebaseAdminModule.formatPrice(item.oldPrice - item.finalPrice)}
                                                        </p>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('') : '<p class="text-gray-500">Aucun article trouvé</p>'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Order Summary & Actions -->
                            <div>
                                <div class="sticky top-0">
                                    <!-- Summary -->
                                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                                        <h4 class="font-semibold text-gray-800 mb-4">Récapitulatif</h4>
                                        <div class="space-y-3">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Sous-total</span>
                                                <span class="font-medium">${FirebaseAdminModule.formatPrice(order.subtotal || 0)}</span>
                                            </div>
                                            ${order.totalWeight ? `
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600">Poids total</span>
                                                    <span class="font-medium">${order.totalWeight} kg</span>
                                                </div>
                                            ` : ''}
                                            <div class="flex justify-between pt-3 border-t border-gray-200">
                                                <span class="text-lg font-bold text-gray-800">Total</span>
                                                <span class="text-xl font-bold text-indigo-600">${FirebaseAdminModule.formatPrice(order.totalAmount || 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="space-y-3">
                                        ${order.status === 'pending_payment' || order.status === 'pending' ? `
                                            <button 
                                                onclick="updateOrderStatus('${order.id}', 'processing')"
                                                class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center"
                                            >
                                                <i class="fas fa-cog mr-2"></i>
                                                Marquer comme en traitement
                                            </button>
                                        ` : ''}
                                        
                                        ${order.status === 'processing' ? `
                                            <button 
                                                onclick="updateOrderStatus('${order.id}', 'confirmed')"
                                                class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center"
                                            >
                                                <i class="fas fa-check-circle mr-2"></i>
                                                Marquer comme confirmée
                                            </button>
                                        ` : ''}
                                        
                                        ${order.status === 'confirmed' ? `
                                            <button 
                                                onclick="updateOrderStatus('${order.id}', 'delivered')"
                                                class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center"
                                            >
                                                <i class="fas fa-shipping-fast mr-2"></i>
                                                Marquer comme livrée
                                            </button>
                                        ` : ''}
                                        
                                        ${order.status === 'pending_payment' || order.status === 'pending' || order.status === 'processing' ? `
                                            <button 
                                                onclick="updateOrderStatus('${order.id}', 'cancelled')"
                                                class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center justify-center"
                                            >
                                                <i class="fas fa-times-circle mr-2"></i>
                                                Annuler la commande
                                            </button>
                                        ` : ''}
                                        
                                        <button 
                                            onclick="closeOrderDetailModal()"
                                            class="w-full py-3 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors duration-300"
                                        >
                                            Fermer
                                        </button>
                                    </div>
                                    
                                    <!-- Order Metadata -->
                                    <div class="mt-6 pt-6 border-t border-gray-200">
                                        <p class="text-xs text-gray-500">
                                            <i class="fas fa-info-circle mr-2"></i>
                                            ID de session: ${order.sessionId ? order.sessionId.substring(0, 12) + '...' : 'Non disponible'}
                                        </p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            <i class="fas fa-barcode mr-2"></i>
                                            Code: ${order.orderCode || 'N/A'}
                                        </p>
                                        ${order.updatedAt ? `
                                            <p class="text-xs text-gray-500 mt-2">
                                                <i class="fas fa-sync-alt mr-2"></i>
                                                Dernière mise à jour: ${FirebaseAdminModule.formatDate(order.updatedAt)}
                                            </p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modalContent.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        /**
         * Fermer le modal de détail
         */
        const closeOrderDetailModal = () => {
            const modal = document.getElementById('order-detail-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            document.body.style.overflow = 'auto';
        };
        
        /**
         * Ouvrir le modal de règle de livraison
         */
        const openDeliveryRuleModal = (ruleId = null) => {
            const modalContent = document.getElementById('delivery-rule-modal');
            if (!modalContent) return;
            
            const rule = ruleId ? adminState.deliveryRules.find(r => r.id === ruleId) : null;
            
            modalContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative z-10">
                    <!-- Modal Header -->
                    <div class="px-8 py-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800">
                                ${rule ? 'Modifier la règle' : 'Nouvelle règle de livraison'}
                            </h3>
                            <button 
                                onclick="closeDeliveryRuleModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
                            >
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="overflow-y-auto max-h-[70vh] p-8">
                        <form id="delivery-rule-form" class="space-y-6">
                            <!-- Poids maximum -->
                            <div>
                                <label for="rule-max-weight" class="block text-sm font-medium text-gray-700 mb-2">
                                    Poids maximum (kg) *
                                </label>
                                <input 
                                    type="number" 
                                    id="rule-max-weight"
                                    required
                                    min="0.1"
                                    step="0.1"
                                    value="${rule ? rule.maxWeight : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex: 5.0"
                                >
                                <p class="text-sm text-gray-500 mt-2">
                                    Poids maximum auquel cette règle s'applique
                                </p>
                            </div>
                            
                            <!-- Frais de base -->
                            <div>
                                <label for="rule-fee" class="block text-sm font-medium text-gray-700 mb-2">
                                    Frais de base (HTG) *
                                </label>
                                <input 
                                    type="number" 
                                    id="rule-fee"
                                    required
                                    min="0"
                                    step="0.01"
                                    value="${rule ? rule.fee : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex: 500"
                                >
                            </div>
                            
                            <!-- Frais supplémentaire pour fragile -->
                            <div>
                                <label for="rule-fragile-fee" class="block text-sm font-medium text-gray-700 mb-2">
                                    Frais supplémentaire pour produit fragile (HTG)
                                </label>
                                <input 
                                    type="number" 
                                    id="rule-fragile-fee"
                                    min="0"
                                    step="0.01"
                                    value="${rule ? (rule.fragileExtraFee || 0) : 0}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                >
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <label for="rule-description" class="block text-sm font-medium text-gray-700 mb-2">
                                    Description
                                </label>
                                <textarea 
                                    id="rule-description"
                                    rows="3"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Description optionnelle de la règle..."
                                >${rule ? (rule.description || '') : ''}</textarea>
                            </div>
                            
                            <!-- Hidden rule ID -->
                            <input type="hidden" id="rule-id" value="${rule ? rule.id : ''}">
                        </form>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="px-8 py-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-end space-x-4">
                            <button 
                                onclick="closeDeliveryRuleModal()"
                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-300"
                            >
                                Annuler
                            </button>
                            <button 
                                type="submit"
                                form="delivery-rule-form"
                                onclick="saveDeliveryRule()"
                                class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center"
                            >
                                <i class="fas fa-save mr-2"></i>
                                ${rule ? 'Mettre à jour' : 'Créer la règle'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContent.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        /**
         * Fermer le modal de règle de livraison
         */
        const closeDeliveryRuleModal = () => {
            const modal = document.getElementById('delivery-rule-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            document.body.style.overflow = 'auto';
        };
        
        /**
         * Ouvrir le modal de point de rencontre
         */
        const openMeetingPointModal = (pointId = null) => {
            const modalContent = document.getElementById('meeting-point-modal');
            if (!modalContent) return;
            
            const point = pointId ? adminState.meetingPoints.find(p => p.id === pointId) : null;
            
            modalContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative z-10">
                    <!-- Modal Header -->
                    <div class="px-8 py-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800">
                                ${point ? 'Modifier le point' : 'Nouveau point de rencontre'}
                            </h3>
                            <button 
                                onclick="closeMeetingPointModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
                            >
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="overflow-y-auto max-h-[70vh] p-8">
                        <form id="meeting-point-form" class="space-y-6">

                            <!-- Nom -->
                            <div>
                                <label for="point-name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nom *
                                </label>
                                <input 
                                    type="text" 
                                    id="point-name"
                                    required
                                    value="${point ? point.name : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex: Place du Marché"
                                >
                            </div>
                            
                            <!-- Adresse -->
                            <div>
                                <label for="point-address" class="block text-sm font-medium text-gray-700 mb-2">
                                    Adresse *
                                </label>
                                <textarea 
                                    id="point-address"
                                    required
                                    rows="2"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Adresse complète du point de rencontre..."
                                >${point ? point.address : ''}</textarea>
                            </div>
                            <!-- Frais de livraison -->
                                <div>
                                <label for="point-fee" class="block text-sm font-medium text-gray-700 mb-2">
                                    Frais de livraison (HTG) *
                                </label>
                                <input 
                                    type="number"
                                    id="point-fee"
                                    min="0"
                                    step="1"
                                    required
                                    value="${point ? (point.deliveryFee || 0) : 0}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Ex: 300"
                                >
                                </div>

                            <!-- Description -->
                            <div>
                                <label for="point-description" class="block text-sm font-medium text-gray-700 mb-2">
                                    Description
                                </label>
                                <textarea 
                                    id="point-description"
                                    rows="3"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Informations supplémentaires (repères, heures conseillées...)"
                                >${point ? (point.description || '') : ''}</textarea>
                            </div>
                            
                            <!-- Coordonnées -->
                            <div>
                                <label for="point-coordinates" class="block text-sm font-medium text-gray-700 mb-2">
                                    Coordonnées (optionnel)
                                </label>
                                <input 
                                    type="text" 
                                    id="point-coordinates"
                                    value="${point ? (point.coordinates || '') : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex: 18.5392,-72.3360"
                                >
                                <p class="text-sm text-gray-500 mt-2">
                                    Format: latitude,longitude (utilisé pour la carte)
                                </p>
                            </div>
                            
                            <!-- Statut actif -->
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="point-active"
                                    ${point ? (point.isActive !== false ? 'checked' : '') : 'checked'}
                                    class="mr-3 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                >
                                <label for="point-active" class="text-sm font-medium text-gray-700">
                                    Point de rencontre actif
                                </label>
                            </div>
                            
                            <!-- Hidden point ID -->
                            <input type="hidden" id="point-id" value="${point ? point.id : ''}">
                        </form>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="px-8 py-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-end space-x-4">
                            <button 
                                onclick="closeMeetingPointModal()"
                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-300"
                            >
                                Annuler
                            </button>
                            <button 
                                type="submit"
                                form="meeting-point-form"
                                onclick="saveMeetingPoint()"
                                class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center"
                            >
                                <i class="fas fa-save mr-2"></i>
                                ${point ? 'Mettre à jour' : 'Créer le point'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContent.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        /**
         * Fermer le modal de point de rencontre
         */
        const closeMeetingPointModal = () => {
            const modal = document.getElementById('meeting-point-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            document.body.style.overflow = 'auto';
        };
        
        /**
         * Ouvrir le modal de magasin
         */
        const openStoreLocationModal = (storeId = null) => {
            const modalContent = document.getElementById('store-location-modal');
            if (!modalContent) return;
            
            const store = storeId ? adminState.storeLocations.find(s => s.id === storeId) : null;
            
            modalContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative z-10">
                    <!-- Modal Header -->
                    <div class="px-8 py-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800">
                                ${store ? 'Modifier le magasin' : 'Nouveau magasin'}
                            </h3>
                            <button 
                                onclick="closeStoreLocationModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
                            >
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="overflow-y-auto max-h-[70vh] p-8">
                        <form id="store-location-form" class="space-y-6">
                            <!-- Nom -->
                            <div>
                                <label for="store-name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nom du magasin *
                                </label>
                                <input 
                                    type="text" 
                                    id="store-name"
                                    required
                                    value="${store ? store.name : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex:Smart cut services Centre-Ville"
                                >
                            </div>
                            
                            <!-- Adresse -->
                            <div>
                                <label for="store-address" class="block text-sm font-medium text-gray-700 mb-2">
                                    Adresse *
                                </label>
                                <textarea 
                                    id="store-address"
                                    required
                                    rows="2"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Adresse complète du magasin..."
                                >${store ? store.address : ''}</textarea>
                            </div>
                            
                            <!-- Horaires d'ouverture -->
                            <div>
                                <label for="store-hours" class="block text-sm font-medium text-gray-700 mb-2">
                                    Horaires d'ouverture *
                                </label>
                                <input 
                                    type="text" 
                                    id="store-hours"
                                    required
                                    value="${store ? store.openingHours : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex: Lundi-Vendredi: 9h-18h, Samedi: 10h-16h"
                                >
                            </div>
                            
                            <!-- Téléphone -->
                            <div>
                                <label for="store-phone" class="block text-sm font-medium text-gray-700 mb-2">
                                    Téléphone (optionnel)
                                </label>
                                <input 
                                    type="tel" 
                                    id="store-phone"
                                    value="${store ? (store.phone || '') : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex: +509 44 44 4444"
                                >
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <label for="store-description" class="block text-sm font-medium text-gray-700 mb-2">
                                    Description
                                </label>
                                <textarea 
                                    id="store-description"
                                    rows="3"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Informations supplémentaires sur le magasin..."
                                >${store ? (store.description || '') : ''}</textarea>
                            </div>
                            
                            <!-- Coordonnées -->
                            <div>
                                <label for="store-coordinates" class="block text-sm font-medium text-gray-700 mb-2">
                                    Coordonnées (optionnel)
                                </label>
                                <input 
                                    type="text" 
                                    id="store-coordinates"
                                    value="${store ? (store.coordinates || '') : ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300"
                                    placeholder="Ex: 18.5392,-72.3360"
                                >
                                <p class="text-sm text-gray-500 mt-2">
                                    Format: latitude,longitude (utilisé pour la carte)
                                </p>
                            </div>
                            
                            <!-- Statut actif -->
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="store-active"
                                    ${store ? (store.isActive !== false ? 'checked' : '') : 'checked'}
                                    class="mr-3 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                >
                                <label for="store-active" class="text-sm font-medium text-gray-700">
                                    Magasin actif
                                </label>
                            </div>
                            
                            <!-- Hidden store ID -->
                            <input type="hidden" id="store-id" value="${store ? store.id : ''}">
                        </form>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="px-8 py-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-end space-x-4">
                            <button 
                                onclick="closeStoreLocationModal()"
                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-300"
                            >
                                Annuler
                            </button>
                            <button 
                                type="submit"
                                form="store-location-form"
                                onclick="saveStoreLocation()"
                                class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-300 flex items-center"
                            >
                                <i class="fas fa-save mr-2"></i>
                                ${store ? 'Mettre à jour' : 'Créer le magasin'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContent.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        /**
         * Fermer le modal de magasin
         */
        const closeStoreLocationModal = () => {
            const modal = document.getElementById('store-location-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            document.body.style.overflow = 'auto';
        };
        
        /**
         * Ouvrir le modal de confirmation
         */
        const openConfirmationModal = (title, message, action, actionData) => {
            const modalContent = document.getElementById('confirmation-modal');
            if (!modalContent) return;
            
            modalContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative z-10">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                        </div>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex justify-end space-x-4">
                            <button 
                                onclick="closeConfirmationModal()"
                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-300"
                            >
                                Annuler
                            </button>
                            <button 
                                onclick="${action}(${typeof actionData === 'string' ? `'${actionData}'` : actionData})"
                                class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-300"
                            >
                                Confirmer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContent.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        /**
         * Fermer le modal de confirmation
         */
        const closeConfirmationModal = () => {
            const modal = document.getElementById('confirmation-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            document.body.style.overflow = 'auto';
        };
        
        return {
            openOrderDetail,
            closeOrderDetailModal,
            openDeliveryRuleModal,
            closeDeliveryRuleModal,
            openMeetingPointModal,
            closeMeetingPointModal,
            openStoreLocationModal,
            closeStoreLocationModal,
            openConfirmationModal,
            closeConfirmationModal
        };
    })();
    
    // ============================================
    // FONCTIONS GLOBALES
    // ============================================
    
    /**
     * Initialiser l'application admin
     */
    window.initializeAdminApp = async () => {
        debugLog('Initialisation de l\'application admin...');
        
        // Mettre à jour l'année courante
        const yearEl = document.getElementById('current-year');
        if (yearEl) {
            yearEl.textContent = new Date().getFullYear();
        }
        
        // Initialiser Firebase
        if (!FirebaseAdminModule.initializeFirebase()) {
            showToast('Impossible de se connecter à Firebase', 'error');
            return;
        }
        
        // Initialiser les collections (crée les collections si elles n'existent pas)
        try {
            await FirebaseAdminModule.initializeCollections();
            debugLog('✅ Collections initialisées avec succès');
        } catch (error) {
            console.error('❌ Erreur d\'initialisation des collections:', error);
            showToast('Erreur lors de l\'initialisation des données: ' + error.message, 'warning');
        }
        
        // Charger les données initiales
        await loadInitialData();
        
        // Configurer les événements
        setupEventListeners();
        
        debugLog('✅ Dashboard Commandes initialisé');
    };
    
    /**
     * Charger les données initiales
     */
    const loadInitialData = async () => {
        adminState.isLoading = true;
        
        try {
            debugLog('Chargement des données initiales...');
            
            // Charger les commandes en temps réel
            OrderManager.loadOrdersRealtime();
            
            // Charger les règles de livraison
            await DeliveryRulesManager.loadDeliveryRules();
            
            // Charger les lieux de livraison
            await LocationsManager.loadMeetingPoints();
            await LocationsManager.loadStoreLocations();
            
            debugLog('✅ Données initiales chargées');
        } catch (error) {
            console.error('❌ Erreur lors du chargement initial:', error);
            showToast('Erreur de chargement des données: ' + error.message, 'error');
        } finally {
            adminState.isLoading = false;
        }
    };
    
    /**
     * Configurer les écouteurs d'événements
     */
    const setupEventListeners = () => {
        debugLog('Configuration des écouteurs d\'événements...');
        
        // Navigation par onglets
        document.querySelectorAll('.tab-indicator').forEach(tab => {
            tab.addEventListener('click', function() {
                this.classList.add('active');
            });
        });
        
        // Recherche de vérification avec Enter
        const orderCodeInput = document.getElementById('order-code-input');
        if (orderCodeInput) {
            orderCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifyOrderCode();
                }
            });
        }
        
        // Écouter la soumission des formulaires
        document.addEventListener('submit', async (e) => {
            const form = e.target;
            e.preventDefault(); // Empêcher le rechargement de la page
            
            if (form.id === 'delivery-rule-form') {
                await saveDeliveryRule();
            }
            
            if (form.id === 'meeting-point-form') {
                await saveMeetingPoint();
            }
            
            if (form.id === 'store-location-form') {
                await saveStoreLocation();
            }
        });
        
        debugLog('✅ Écouteurs d\'événements configurés');
    };
    
    /**
     * Changer d'onglet
     */
    window.switchTab = (tabName) => {
        debugLog(`Changement d'onglet: ${tabName}`);
        
        // Mettre à jour l'état
        adminState.currentTab = tabName;
        
        // Mettre à jour les indicateurs d'onglets
        document.querySelectorAll('.tab-indicator').forEach(tab => {
            tab.classList.remove('active', 'text-indigo-600');
            tab.classList.add('text-gray-500');
        });
        
        const activeTab = document.getElementById(`tab-${tabName}`);
        if (activeTab) {
            activeTab.classList.add('active', 'text-indigo-600');
            activeTab.classList.remove('text-gray-500');
        }
        
        // Afficher le contenu de l'onglet
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        const activeContent = document.getElementById(`tab-content-${tabName}`);
        if (activeContent) {
            activeContent.classList.remove('hidden');
            
            // Charger l'historique si nécessaire
            if (tabName === 'order-history') {
                setTimeout(() => {
                    OrderManager.applyHistoryFilter();
                }, 100);
            }
        }
    };
    
    /**
     * Filtrer les commandes actives
     */
    window.filterOrders = (filterType) => {
        debugLog(`Filtrage commandes: ${filterType}`);
        adminState.currentOrderFilter = filterType;
        OrderManager.applyOrderFilter();
    };
    
    /**
     * Ouvrir le détail d'une commande
     */
    window.openOrderDetail = (orderId) => {
        debugLog(`Ouverture détail commande: ${orderId}`);
        ModalManager.openOrderDetail(orderId);
    };
    
    /**
     * Fermer le détail d'une commande
     */
    window.closeOrderDetailModal = () => {
        debugLog('Fermeture modal détail commande');
        ModalManager.closeOrderDetailModal();
    };
    
    /**
     * Mettre à jour le statut d'une commande
     */
    window.updateOrderStatus = async (orderId, newStatus) => {
        debugLog(`Mise à jour statut ${orderId} -> ${newStatus}`);
        await OrderManager.updateOrderStatus(orderId, newStatus);
    };
    
    /**
     * Vérifier un code de commande
     */
    window.verifyOrderCode = async () => {
        const orderCodeInput = document.getElementById('order-code-input');
        const orderCode = orderCodeInput?.value.trim().toUpperCase();
        
        if (!orderCode) {
            showToast('Veuillez entrer un code de commande', 'warning');
            return;
        }
        
        debugLog(`Vérification code: ${orderCode}`);
        
        // Afficher un indicateur de chargement
        const verifyBtn = document.querySelector('[onclick="verifyOrderCode()"]');
        if (verifyBtn) {
            const originalText = verifyBtn.innerHTML;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Vérification...';
            verifyBtn.disabled = true;
            
            try {
                const result = await OrderManager.verifyOrderCode(orderCode);
                OrderManager.displayVerificationResult(result);
            } finally {
                // Restaurer le bouton
                verifyBtn.innerHTML = originalText;
                verifyBtn.disabled = false;
            }
        }
    };
    
    /**
     * Filtrer l'historique
     */
    window.filterHistory = (filterType) => {
        debugLog(`Filtrage historique: ${filterType}`);
        adminState.currentHistoryFilter = filterType;
        OrderManager.applyHistoryFilter();
    };
    
    /**
     * Appliquer les filtres d'historique
     */
    window.applyHistoryFilters = () => {
        debugLog('Application filtres historique');
        OrderManager.applyHistoryFilter();
    };
    
    /**
     * Ouvrir le modal de règle de livraison
     */
    window.openDeliveryRuleModal = (ruleId = null) => {
        debugLog(`Ouverture modal règle: ${ruleId || 'nouvelle'}`);
        ModalManager.openDeliveryRuleModal(ruleId);
    };
    
    /**
     * Fermer le modal de règle de livraison
     */
    window.closeDeliveryRuleModal = () => {
        debugLog('Fermeture modal règle');
        ModalManager.closeDeliveryRuleModal();
    };
    
    /**
     * Éditer une règle de livraison
     */
    window.editDeliveryRule = (ruleId) => {
        debugLog(`Édition règle: ${ruleId}`);
        openDeliveryRuleModal(ruleId);
    };
    
    /**
     * Sauvegarder une règle de livraison
     */
    window.saveDeliveryRule = async () => {
        try {
            debugLog('Début sauvegarde règle');
            
            const ruleId = document.getElementById('rule-id')?.value || null;
            const maxWeight = document.getElementById('rule-max-weight')?.value;
            const fee = document.getElementById('rule-fee')?.value;
            const fragileExtraFee = document.getElementById('rule-fragile-fee')?.value || 0;
            const description = document.getElementById('rule-description')?.value;
            
            debugLog('Données du formulaire:', { ruleId, maxWeight, fee, fragileExtraFee, description });
            
            // Validation
            if (!maxWeight || !fee) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            const ruleData = {
                maxWeight: maxWeight,
                fee: fee,
                fragileExtraFee: fragileExtraFee,
                description: description
            };
            
            const success = await DeliveryRulesManager.saveDeliveryRule(ruleData, ruleId);
            if (success) {
                ModalManager.closeDeliveryRuleModal();
            }
        } catch (error) {
            console.error('❌ Erreur dans saveDeliveryRule:', error);
            showToast('Erreur: ' + error.message, 'error');
        }
    };
    
    /**
     * Confirmer la suppression d'une règle
     */
    window.confirmDeleteDeliveryRule = (ruleId, maxWeight) => {
        debugLog(`Confirmation suppression règle ${ruleId}`);
        ModalManager.openConfirmationModal(
            'Supprimer la règle',
            `Êtes-vous sûr de vouloir supprimer la règle pour ${maxWeight} kg ? Cette action est irréversible.`,
            'deleteDeliveryRule',
            ruleId
        );
    };
    
    /**
     * Supprimer une règle de livraison
     */
    window.deleteDeliveryRule = async (ruleId) => {
        debugLog(`Suppression règle ${ruleId}`);
        await DeliveryRulesManager.deleteDeliveryRule(ruleId);
        ModalManager.closeConfirmationModal();
    };
    
    /**
     * Ouvrir le modal de point de rencontre
     */
    window.openMeetingPointModal = (pointId = null) => {
        debugLog(`Ouverture modal point: ${pointId || 'nouveau'}`);
        ModalManager.openMeetingPointModal(pointId);
    };
    
    /**
     * Fermer le modal de point de rencontre
     */
    window.closeMeetingPointModal = () => {
        debugLog('Fermeture modal point');
        ModalManager.closeMeetingPointModal();
    };
    
    /**
     * Éditer un point de rencontre
     */
    window.editMeetingPoint = (pointId) => {
        debugLog(`Édition point: ${pointId}`);
        openMeetingPointModal(pointId);
    };
    
    /**
     * Sauvegarder un point de rencontre
     */
    window.saveMeetingPoint = async () => {
        try {
            debugLog('Début sauvegarde point');
            const deliveryFee = document.getElementById('point-fee')?.value;

            const pointId = document.getElementById('point-id')?.value || null;
            const name = document.getElementById('point-name')?.value;
            const address = document.getElementById('point-address')?.value;
            const description = document.getElementById('point-description')?.value;
            const coordinates = document.getElementById('point-coordinates')?.value;
            const isActive = document.getElementById('point-active')?.checked;
            
            debugLog('Données du formulaire:', { pointId, name, address, description, coordinates, isActive });
            
            // Validation
            if (!name || !address) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            const pointData = {
                name: name,
                address: address,
                description: description,
                coordinates: coordinates,
                isActive: isActive,
                deliveryFee: deliveryFee
            };
            
            const success = await LocationsManager.saveMeetingPoint(pointData, pointId);
            if (success) {
                ModalManager.closeMeetingPointModal();
            }
        } catch (error) {
            console.error('❌ Erreur dans saveMeetingPoint:', error);
            showToast('Erreur: ' + error.message, 'error');
        }
    };
    
    /**
     * Confirmer la suppression d'un point de rencontre
     */
    window.confirmDeleteMeetingPoint = (pointId, pointName) => {
        debugLog(`Confirmation suppression point ${pointId}`);
        ModalManager.openConfirmationModal(
            'Supprimer le point',
            `Êtes-vous sûr de vouloir supprimer "${pointName}" ? Cette action est irréversible.`,
            'deleteMeetingPoint',
            pointId
        );
    };
    
    /**
     * Supprimer un point de rencontre
     */
    window.deleteMeetingPoint = async (pointId) => {
        debugLog(`Suppression point ${pointId}`);
        await LocationsManager.deleteMeetingPoint(pointId);
        ModalManager.closeConfirmationModal();
    };
    
    /**
     * Basculer l'activité d'un point de rencontre
     */
    window.toggleMeetingPointActive = async (pointId, isActive) => {
        debugLog(`Toggle point ${pointId} -> ${isActive}`);
        await LocationsManager.toggleMeetingPointActive(pointId, isActive);
    };
    
    /**
     * Ouvrir le modal de magasin
     */
    window.openStoreLocationModal = (storeId = null) => {
        debugLog(`Ouverture modal magasin: ${storeId || 'nouveau'}`);
        ModalManager.openStoreLocationModal(storeId);
    };
    
    /**
     * Fermer le modal de magasin
     */
    window.closeStoreLocationModal = () => {
        debugLog('Fermeture modal magasin');
        ModalManager.closeStoreLocationModal();
    };
    
    /**
     * Éditer un magasin
     */
    window.editStoreLocation = (storeId) => {
        debugLog(`Édition magasin: ${storeId}`);
        openStoreLocationModal(storeId);
    };
    
    /**
     * Sauvegarder un magasin
     */
    window.saveStoreLocation = async () => {
        try {
            debugLog('Début sauvegarde magasin');
            
            const storeId = document.getElementById('store-id')?.value || null;
            const name = document.getElementById('store-name')?.value;
            const address = document.getElementById('store-address')?.value;
            const openingHours = document.getElementById('store-hours')?.value;
            const phone = document.getElementById('store-phone')?.value;
            const description = document.getElementById('store-description')?.value;
            const coordinates = document.getElementById('store-coordinates')?.value;
            const isActive = document.getElementById('store-active')?.checked;
            
            debugLog('Données du formulaire:', { storeId, name, address, openingHours, phone, description, coordinates, isActive });
            
            // Validation
            if (!name || !address || !openingHours) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            const storeData = {
                name: name,
                address: address,
                openingHours: openingHours,
                phone: phone,
                description: description,
                coordinates: coordinates,
                isActive: isActive
            };
            
            const success = await LocationsManager.saveStoreLocation(storeData, storeId);
            if (success) {
                ModalManager.closeStoreLocationModal();
            }
        } catch (error) {
            console.error('❌ Erreur dans saveStoreLocation:', error);
            showToast('Erreur: ' + error.message, 'error');
        }
    };
    
    /**
     * Confirmer la suppression d'un magasin
     */
    window.confirmDeleteStoreLocation = (storeId, storeName) => {
        debugLog(`Confirmation suppression magasin ${storeId}`);
        ModalManager.openConfirmationModal(
            'Supprimer le magasin',
            `Êtes-vous sûr de vouloir supprimer "${storeName}" ? Cette action est irréversible.`,
            'deleteStoreLocation',
            storeId
        );
    };
    
    /**
     * Supprimer un magasin
     */
    window.deleteStoreLocation = async (storeId) => {
        debugLog(`Suppression magasin ${storeId}`);
        await LocationsManager.deleteStoreLocation(storeId);
        ModalManager.closeConfirmationModal();
    };
    
    /**
     * Basculer l'activité d'un magasin
     */
    window.toggleStoreLocationActive = async (storeId, isActive) => {
        debugLog(`Toggle magasin ${storeId} -> ${isActive}`);
        await LocationsManager.toggleStoreLocationActive(storeId, isActive);
    };
    
    /**
     * Fermer le modal de confirmation
     */
    window.closeConfirmationModal = () => {
        debugLog('Fermeture modal confirmation');
        ModalManager.closeConfirmationModal();
    };
    
    // ============================================
    // INITIALISATION AU CHARGEMENT DE LA PAGE
    // ============================================
    
    document.addEventListener('DOMContentLoaded', () => {
        debugLog('DOM chargé, initialisation...');
        window.initializeAdminApp().catch(error => {
            console.error('❌ Erreur lors de l\'initialisation:', error);
            showToast('Erreur d\'initialisation: ' + error.message, 'error');
        });
    });
    
</script>
</body>
</html>